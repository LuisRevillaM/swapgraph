# M112 â€” Storage hardening and SQLite migration path (implemented, fixtures-first)

Status: Implemented and verifier-closed on 2026-02-22 (`npm run verify:m112`, `node verify/runner.mjs milestones/M112.yaml`).

## Objective
Harden runtime persistence for deployment by activating an explicit storage backend path (`json` or `sqlite`) without changing API contracts.

## Scope
### A) Backend selection and runtime diagnostics
1. Runtime store selector: `STATE_BACKEND=json|sqlite` with backend-aware default state file resolution.
2. Runtime health diagnostics include active backend and persistence mode:
   - `store_backend`
   - `persistence_mode`
3. Runtime close path now closes backend handles for non-JSON stores.

### B) SQLite activation + migration/ops path
1. SQLite-backed state store (`src/store/sqliteStateStore.mjs`) with WAL persistence mode.
2. Deterministic migration utility (`scripts/migrate-state-store.mjs`) supporting:
   - JSON -> SQLite bootstrap migration
   - SQLite -> JSON backup export
   - JSON -> SQLite restore import
3. Convenience wrapper for direct JSON -> SQLite migration:
   - `scripts/migrate-json-state-to-sqlite.mjs`

### C) Deterministic durability verification
1. JSON runtime write -> JSON->SQLite migration -> SQLite runtime read.
2. SQLite runtime write -> restart -> read durability assertion.
3. SQLite->JSON backup + JSON->SQLite restore with hash-parity assertions.

## Deterministic reason-code floor (ops tooling)
- `state_migration_source_missing`
- `state_migration_target_exists`
- `state_migration_hash_mismatch`
- `sqlite_unavailable`

## Non-goals (M112)
- No API contract shape changes.
- No matching heuristic changes.
- No client/UI implementation work.

## Acceptance
M112 is accepted when:
1. runtime can run with SQLite backend and preserve state across restart,
2. schema/contract/auth validators remain green,
3. migration tooling deterministically migrates JSON state into SQLite,
4. backup/restore path is verifier-covered and documented.

## Implementation closure gate (M112)
M112 implementation closure is achieved when:
- `npm run verify:m112` exits 0.
- `node verify/runner.mjs milestones/M112.yaml` returns `overall=true`.
- Artifacts are present under `artifacts/milestones/M112/latest/*`.
