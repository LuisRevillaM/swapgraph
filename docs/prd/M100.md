# M100 — Metrics and network health contracts (PRD-only, implementation-ready)

## Objective
Convert v2 metrics/network-health section into deterministic, contract-backed API surfaces suitable for partner and operator instrumentation.

## Scope
### A) Metrics read surfaces (to define)
1. `metrics.north_star.get` → `GET /metrics/north-star`
   - weekly successful swaps per active trader
   - fill-rate within configured window
2. `metrics.marketplace_funnel.get` → `GET /metrics/marketplace-funnel`
   - connect → sync → intent → proposal viewed → accepted → deposited → completed funnel
3. `metrics.partner_health.get` → `GET /metrics/partner-health`
   - partner/API operational metrics (proposal delivery, commit/completion, webhook health)
4. `metrics.safety_health.get` → `GET /metrics/safety-health`
   - safety/trust metrics (fraud flags, confirmed abuse, unwind frequency, felt-safe proxy)

### B) Metrics export surface (to define)
1. `metrics.network_health.export` → `GET /metrics/network-health/export`
   - signed metrics export
   - deterministic continuation + tamper-fail verification

## Proposed contract map (for approval)

### Query envelope (common)
- `from_iso` (required)
- `to_iso` (required)
- `bucket` (`hour|day|week`, default `day`)
- `partner_id` (optional filter for scoped partner views)
- `limit`, `cursor_after` (export paging)
- `attestation_after`, `checkpoint_after` (export continuity)

### Deterministic aggregation semantics (proposed)
- Timezone fixed to UTC.
- Window boundaries are inclusive of `from_iso`, exclusive of `to_iso`.
- Empty windows return zeroed aggregates, never null summaries.
- All rate metrics include explicit denominators in response payloads.

### Summary metrics floor (proposed)
- `weekly_successful_swaps_per_active_trader`
- `fill_rate_7d_bps`
- `proposal_to_accept_bps`
- `accept_to_complete_bps`
- `webhook_delivery_success_bps`
- `fraud_flags_per_1000_intents`
- `unwind_rate_bps`

## Contract constraints
- Read surfaces must be partner/tenant scoped.
- Aggregation determinism is mandatory for fixture reproducibility.
- Export surfaces must be signed and continuity-verifiable.

## Proposed schema artifacts (naming target)
- `MetricsNorthStarGetResponse.schema.json`
- `MetricsMarketplaceFunnelGetResponse.schema.json`
- `MetricsPartnerHealthGetResponse.schema.json`
- `MetricsSafetyHealthGetResponse.schema.json`
- `MetricsNetworkHealthExportResponse.schema.json`

## Deterministic reason-code floor (proposed)
- `metrics_query_invalid`
- `metrics_window_invalid`
- `metrics_bucket_invalid`
- `metrics_export_query_invalid`
- `metrics_export_cursor_not_found`
- `metrics_export_checkpoint_required`
- `metrics_export_checkpoint_mismatch`

## PRD review closure matrix
| Decision | Proposal | Status |
|---|---|---|
| Primary north-star metric | Keep both metrics in contract summary; mark one as configurable primary (`weekly_successful_swaps_per_active_trader` default) | Pending approval |
| Window semantics | UTC; `[from_iso, to_iso)` boundaries | Pending approval |
| Partner visibility | Partner endpoints return tenant-scoped slices only | Pending approval |
| Denominator policy | All rates include explicit denominator fields | Pending approval |
| Export continuity | Signed export + attestation + checkpoint continuity required | Pending approval |
| Scope model | Reuse existing `settlement:read` for first implementation tranche | Pending approval |

## Non-goals (M100)
- No dashboard UI implementation.
- No BI/warehouse integration rollout.
- No real-time analytics pipeline implementation.
- No implementation work in this milestone until PRD approval is explicit.

## Acceptance (PRD stage)
- M100 PRD is accepted when:
  1. metric taxonomy is frozen,
  2. aggregation/window semantics are explicit,
  3. partner visibility constraints are approved,
  4. signed export continuity requirements are approved.

## Acceptance (future implementation stage)
- `npm run verify:m100` exits 0.
- `node verify/runner.ts milestones/M100.yaml` returns `overall=true`.
- Artifacts under `artifacts/milestones/M100/latest/*`.
