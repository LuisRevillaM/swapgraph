# M19 â€” Proposal delivery persistence + partner scoping (polling + webhook ingestion)

## Objective
Make **proposal delivery** verifiable end-to-end by proving that partner-delivered `CycleProposal`s can be:
1) **ingested** from either polling or webhooks,
2) **persisted** into store state (`store.state.proposals`),
3) **scoped** to the delivering `partner_id` (`store.state.tenancy.proposals[proposal_id].partner_id`), and
4) re-ingested **idempotently** (duplicate webhook `event_id` and full replay do not change final state).

This remains **fixtures-first** (no HTTP server).

## Inputs
- Delivery fixture output from **M6**:
  - polling response: `CycleProposalListResponse`
  - webhook events: `EventEnvelope` with `proposal.created` payload

## Rules (v1)
- Only `partner` can ingest delivery artifacts.
- Proposal scoping is stored as:
  - `store.state.tenancy.proposals[proposal_id] = { partner_id }`
- Webhook ingestion dedupes by `event_id`.

## Scope
- Add a small ingest module that:
  - ingests polling responses into `store.state.proposals`
  - ingests `proposal.created` webhook events into `store.state.proposals`
  - writes partner scoping into `store.state.tenancy.proposals`
- Add a fixtures scenario that:
  - validates the M6 delivery fixture (polling + webhook) against schemas,
  - ingests from polling and from webhooks into separate fresh stores,
  - proves equivalence of the resulting proposal sets,
  - replays webhook ingestion and proves no changes,
  - runs `cycleProposals.list/get` reads using the M18 read service to prove authz.

## Acceptance criteria
- `npm run verify:m19` exits 0.
- `node verify/runner.mjs milestones/M19.yaml` exits 0.

## Required artifacts
- `docs/prd/M19.md`
- `fixtures/delivery/m19_scenario.json`
- `fixtures/delivery/m19_expected.json`
- `src/delivery/proposalIngestService.mjs`
- `scripts/run-m19-delivery-persistence-scenario.mjs`
- Proof outputs under `artifacts/milestones/M19/latest/*`
