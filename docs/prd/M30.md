# M30 â€” Partner auth scopes (contract) + webhook ingestion hardening (signature verify + persistent dedupe)

## Objective
Close the remaining **integration security** gaps for v1:
1) Make **auth scopes** explicit in the API contract (what operations a principal is allowed to perform).
2) Harden webhook/event ingestion so consumers can safely apply at-least-once deliveries:
   - verify `EventEnvelope.signature` before applying
   - persist `event_id` dedupe state so duplicates remain safe across restarts

This milestone stays **fixtures-first** (no HTTP server yet). We prove the contract + behavior via deterministic verifiers.

## Scope

## 1) Auth scopes contract (API-first)
Define a stable scope taxonomy and annotate every endpoint in `docs/spec/api/manifest.v1.json` with:
- `auth.required` (boolean)
- `auth.allowed_actor_types` (array of `user|partner|agent`)
- `auth.required_scopes` (array of scope strings)

Add `docs/spec/AUTH.md` documenting:
- headers (`X-Partner-Key`, `Authorization: Bearer ...`)
- scope meanings

Add a validator:
- `scripts/validate-api-auth.mjs`

## 2) Webhook ingestion hardening (fixtures-first)
Update `src/delivery/proposalIngestService.mjs`:
- verify `EventEnvelope.signature` using the published key set
  - key set source (fixtures-first): `docs/spec/examples/api/keys.event_signing.get.response.json`
- persist a JSON-serializable dedupe set in store:
  - `store.state.delivery.webhook_seen_event_ids[event_id] = true`
- return deterministic stats including invalid signatures

Update scenario scripts that ingest webhook events to pass the key set:
- `scripts/run-m19-delivery-persistence-scenario.mjs`
- `scripts/run-m24-e2e-pipeline-scenario.mjs`

## 3) Verification (proof-gated)
Add a deterministic scenario proving:
- valid signed webhook events ingest successfully
- duplicates are ignored **after store reload** (persistence proof)
- a tampered event fails signature verification and is rejected

## Acceptance criteria
- `npm run verify:m30` exits 0.
- `node verify/runner.mjs milestones/M30.yaml` exits 0.

## Required artifacts
- `docs/prd/M30.md`
- `docs/spec/AUTH.md`
- updated `docs/spec/api/manifest.v1.json` with auth scopes
- `scripts/validate-api-auth.mjs`
- hardened webhook ingest module + proof artifacts under `artifacts/milestones/M30/latest/*`
