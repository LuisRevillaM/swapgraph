# M39 â€” High-value consent tier hardening + delegated-policy audit read contract

## Objective
Strengthen delegated high-value write controls and make delegated policy decisions externally readable via a user-scoped audit API contract.

## Scope

### 1) Consent tier hardening (opt-in)
Extend high-value delegated write checks for `swapIntents.create/update`:
- keep `high_value_consent_threshold_usd` trigger
- when `POLICY_CONSENT_TIER_ENFORCE=1`, require:
  - `auth.user_consent.consent_tier` (`step_up` or `passkey`)
  - `auth.user_consent.consent_proof` (non-empty)
- derive required tier from value severity:
  - moderate high value: `step_up`
  - very high value: `passkey`
- return deterministic deny reason codes for missing/insufficient tier

### 2) Delegated policy audit API contract
Add endpoint contract:
- `GET /policy-audit/delegated-writes`

Behavior (fixtures-first):
- user-scoped (`actor.type=user`, `delegations:read`)
- optional filters (`decision`, `operation_id`, `delegation_id`, `limit`)
- returns deterministic `PolicyAuditEntry[]`

### 3) Shared policy helper alignment
Ensure helper module supports:
- consent-tier evaluation and reason-code mapping
- day-bucket spend checks
- intent/proposal boundary checks

### 4) Proof scenario
Add deterministic scenario proving:
- high-value write denied without consent
- high-value write denied when tier is missing/insufficient under tier hardening
- high-value write allowed when tier/proof are sufficient
- audit list endpoint returns expected entries and supports filters
- agent token cannot read user-only policy audit endpoint

## Acceptance criteria
- `npm run verify:m39` exits 0.
- `node verify/runner.mjs milestones/M39.yaml` overall=true.
- artifacts under `artifacts/milestones/M39/latest/*`.
