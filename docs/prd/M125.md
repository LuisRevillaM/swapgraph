# M125 â€” Runtime TypeScript matcher shadow (non-breaking, parity telemetry)

## Objective
Run a TypeScript-sourced matcher implementation in shadow mode inside runtime matching execution so we can measure parity and failures without changing authoritative behavior.

## Scope
- Add runtime-generated TS shadow matcher modules under `src/matching-ts-shadow/*.mjs` sourced from `src-ts/matching/*.mts`.
- Add sync/check utility:
  - `scripts/sync-matching-ts-shadow-runtime.mjs`
  - write mode (default) to regenerate runtime shadow modules
  - `--check` mode for verifier hermeticity
- Integrate TS shadow run path into `MarketplaceMatchingService.runMatching` behind env controls:
  - `MATCHING_TS_SHADOW`
  - `MATCHING_TS_SHADOW_FORCE_ERROR`
  - `MATCHING_TS_SHADOW_MAX_DIFFS`
- Persist per-run TS shadow parity/error records in:
  - `state.marketplace_matching_ts_shadow_diffs[run_id]`
- Add retention pruning for TS shadow records by run sequence.
- Add fixture-driven M125 scenario/verifier and milestone gate artifacts.

## Non-goals (M125)
- No runtime cutover to TS matcher outputs.
- No API contract changes for matching endpoints.
- No matcher algorithm changes.
- No migration of non-matching service/store modules to TS runtime execution.

## Acceptance criteria
- `npm run verify:m125` exits 0.
- `npm run verify:m124` exits 0 (composed dependency gate).
- `npm run verify:m120` exits 0 (runtime matching behavior dependency gate).
- TS shadow records are deterministic structurally across identical snapshots and fail-open on forced TS shadow errors.
- Deterministic proof artifacts exist at `artifacts/milestones/M125/latest/*`.

## Required artifacts
- `docs/prd/M125.md`
- `scripts/sync-matching-ts-shadow-runtime.mjs`
- `src/matching-ts-shadow/assetKeys.mjs`
- `src/matching-ts-shadow/cycles.mjs`
- `src/matching-ts-shadow/engine.mjs`
- `src/matching-ts-shadow/graph.mjs`
- `src/matching-ts-shadow/index.mjs`
- `src/matching-ts-shadow/proposals.mjs`
- `src/matching-ts-shadow/scoring.mjs`
- `src/matching-ts-shadow/values.mjs`
- `src/matching-ts-shadow/wantSpec.mjs`
- `src/service/marketplaceMatchingService.mjs`
- `scripts/run-m125-typescript-runtime-shadow-scenario.mjs`
- `fixtures/release/m125_scenario.json`
- `fixtures/release/m125_expected.json`
- `verify/m125.sh`
- `milestones/M125.yaml`
- `artifacts/milestones/M125/latest/typescript_runtime_shadow_output.json`
- `artifacts/milestones/M125/latest/assertions.json`
- `artifacts/milestones/M125/latest/commands.log`
