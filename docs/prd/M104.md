# M104 — Swarm simulation contracts (implemented, fixtures-first)

Status: Implemented and verifier-closed on 2026-02-22 (`npm run verify:m104`, `node verify/runner.mjs milestones/M104.yaml`).

## Objective
Define a simulation-only LP mode that uses the same API primitives as production flows while remaining custody-isolated and explicitly labeled as non-real.

## Why this is required (integration findings)
- Current engine already supports deterministic fixtures and receipt-style artifacts.
- No dedicated simulation contract namespace exists.
- LP strategy should be testable without platform-custody risk.

## Scope
### A) Simulation session contracts (implemented)
1. `liquiditySimulation.session.start` → `POST /liquidity-simulation/sessions`
2. `liquiditySimulation.session.get` → `GET /liquidity-simulation/sessions/{session_id}`
3. `liquiditySimulation.session.stop` → `POST /liquidity-simulation/sessions/{session_id}/stop`

### B) Simulation flow contracts (implemented)
1. `liquiditySimulation.intent.sync` → `POST /liquidity-simulation/sessions/{session_id}/intents/sync`
2. `liquiditySimulation.cycle.export` → `GET /liquidity-simulation/sessions/{session_id}/cycles/export`
3. `liquiditySimulation.receipt.export` → `GET /liquidity-simulation/sessions/{session_id}/receipts/export`

### C) Simulation invariants
- Simulation outputs must never be mixed with real receipt/transparency log chains.
- Simulation payloads must include `simulation=true` and `simulation_session_id`.
- All simulation writes remain idempotent and auditable.
- Swarm internal actions must go through contract APIs (no direct DB-only write path).

## Schema artifacts (implemented)
- `LiquiditySimulationSessionStartRequest.schema.json`
- `LiquiditySimulationSessionStartResponse.schema.json`
- `LiquiditySimulationSessionGetResponse.schema.json`
- `LiquiditySimulationIntentSyncRequest.schema.json`
- `LiquiditySimulationIntentSyncResponse.schema.json`
- `LiquiditySimulationCycleExportResponse.schema.json`
- `LiquiditySimulationReceiptExportResponse.schema.json`

## Event additions (implemented)
- `liquidity.simulation_session.started`
- `liquidity.simulation_cycle.completed`
- `liquidity.simulation_session.stopped`

## Deterministic reason-code floor (enforced)
- `liquidity_simulation_invalid`
- `liquidity_simulation_session_not_found`
- `liquidity_simulation_session_inactive`
- `liquidity_simulation_payload_invalid`
- `liquidity_simulation_export_query_invalid`

## Non-goals (M104)
- No real platform transfer execution.
- No production-facing bot behavior changes.
- No UI implementation beyond contract payload requirements.

## Acceptance (implementation stage)
- `npm run verify:m104` exits 0.
- `node verify/runner.mjs milestones/M104.yaml` returns `overall=true`.
- Artifacts under `artifacts/milestones/M104/latest/*`.
