# M37 â€” Delegation TradingPolicy enforcement across matching/commit/settlement read boundaries (fixtures-first)

## Objective
Extend delegated-agent policy enforcement beyond `swapIntents.*` so delegated reads at downstream boundaries are also constrained by `TradingPolicy`.

This milestone keeps commit consent semantics unchanged:
- `cycleProposals.accept/decline` remain user-only.

## Scope

### 1) Matching boundary: policy-gated proposal visibility
For delegated agent reads:
- `cycleProposals.list`
- `cycleProposals.get`

enforce policy checks against proposal shape:
- `participants.length <= policy.max_cycle_length` (when configured)
- `confidence_score >= policy.min_confidence_score`

Behavior:
- list filters out proposals violating policy
- get returns `FORBIDDEN` on policy violation

### 2) Commit boundary: delegated read policy checks
Allow delegated agents to read commits under scope + delegation:
- `commits.get` allows `actor.type=agent` (with `commits:read`)

Enforcement:
- delegated subject must be a participant in the commit
- linked proposal (`commit.cycle_id`) must satisfy policy checks above

### 3) Settlement boundary: policy checks on timeline/receipt reads
For delegated agent reads:
- `settlement.status`
- `settlement.instructions`
- `receipts.get`

enforce linked proposal policy checks as above.

Additionally for `settlement.instructions`:
- enforce `quiet_hours` when `auth.now_iso` (or `AUTHZ_NOW_ISO`) is present
- return `FORBIDDEN` while inside quiet-hours window

### 4) Shared policy helper module
Add `src/core/tradingPolicyBoundaries.mjs` with reusable helpers for:
- actor/delegation subject resolution
- proposal-vs-policy evaluation
- quiet-hours evaluation

### 5) Proof scenario
Add deterministic scenario proving:
- delegated list/get only expose policy-compliant proposal(s)
- delegated commit read is allowed only for compliant proposal
- settlement status/receipt reads fail for policy-violating cycle
- settlement instructions are blocked during quiet hours and allowed outside quiet hours

## Acceptance criteria
- `npm run verify:m37` exits 0.
- `node verify/runner.ts milestones/M37.yaml` overall=true.
- proof artifacts under `artifacts/milestones/M37/latest/*`.
