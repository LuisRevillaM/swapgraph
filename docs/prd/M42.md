# M42 — Consent-proof anti-replay + signed export attestation continuity

## Objective
Harden delegated authorization and offline audit integrity by adding:
1) anti-replay enforcement for signed consent proofs, and
2) pagination attestation continuity for signed delegated policy-audit exports.

## Scope

### 1) Consent-proof anti-replay (opt-in)
When all controls are enabled:
- `POLICY_CONSENT_TIER_ENFORCE=1`
- `POLICY_CONSENT_PROOF_BIND_ENFORCE=1`
- `POLICY_CONSENT_PROOF_SIG_ENFORCE=1`
- `POLICY_CONSENT_PROOF_REPLAY_ENFORCE=1`

High-value writes require signed consent proof nonce uniqueness in binding context:
- replay key = (`consent_id`, subject actor, delegation id, nonce)
- first use is accepted and recorded
- subsequent reuse is denied deterministically (`consent_proof_replayed`)

Deterministic reason-codes added/validated:
- `consent_proof_nonce_required`
- `consent_proof_replayed`
- `consent_proof_replay_config_invalid` (guardrail)

### 2) Signed export pagination attestations
Extend `GET /policy-audit/delegated-writes/export`:
- allow pagination params (`limit`, `cursor_after`)
- continuation requires `attestation_after` when `cursor_after` is present
- reject `attestation_after` when `cursor_after` is absent

Paginated exports include signed continuity metadata:
- `next_cursor`
- `attestation`:
  - `cursor_after`
  - `next_cursor`
  - `attestation_after`
  - `page_hash`
  - `chain_hash`

`export_hash` + signature + attestation must verify offline via policy-integrity keys.

### 3) Store hardening
Persist replay-tracking state in store:
- `policy_consent_replay`

### 4) Fixtures-first proof
Deterministic scenario proves:
- signed consent with nonce succeeds once,
- replayed nonce is denied,
- missing nonce denied when replay enforcement enabled,
- paginated export page-1/page-2 chain continuity validates,
- tampered attestation hash fails verification,
- malformed pagination/attestation query states are rejected,
- user-only export access remains enforced.

## Acceptance criteria
- `npm run verify:m42` exits 0.
- `node verify/runner.ts milestones/M42.yaml` returns `overall=true`.
- artifacts written to `artifacts/milestones/M42/latest/*`.
- regression sweep remains green (`verify:m41` … `verify:m32`).
