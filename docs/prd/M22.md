# M22 — Settlement actions via API service (store-backed + partner-scoped)

## Objective
Make settlement write actions behave like real API handlers:
- **no injected timeline/proposal objects**
- actions operate on store state
- partner-scoped writes are enforced

This milestone covers these actions:
- `settlement.deposit_confirmed` (participant user)
- `settlement.begin_execution` (partner only)
- `settlement.complete` (partner only)

Still **fixtures-first** (no HTTP server).

## Inputs
- Proposals seeded into `store.state.proposals` from `fixtures/matching/m5_expected.json`.
- Proposal partner scoping seeded into `store.state.tenancy.proposals`.
- Commit acceptance uses M20’s store-backed commit API.
- Settlement start uses M21’s store-backed, scoped start service.

## Rules (v1)
- `settlement.deposit_confirmed`
  - Only `user` actors (depositors) may confirm deposits.
  - Non-depositor users fail with a structured error.
- `settlement.begin_execution` and `settlement.complete`
  - Only the owning `partner` may call them.
  - Owning partner is `store.state.tenancy.cycles[cycle_id].partner_id`.

## Scope
- Add `src/service/settlementActionsService.mjs`:
  - wraps `SettlementService` and enforces actor type + partner scoping on cycle writes.
- Add a scenario that proves:
  - outsider user cannot confirm deposit
  - partner mismatch cannot begin execution / complete
  - correct partner can begin execution + complete
  - final receipt exists and reservations are released

## Acceptance criteria
- `npm run verify:m22` exits 0.
- `node verify/runner.mjs milestones/M22.yaml` exits 0.

## Required artifacts
- `docs/prd/M22.md`
- `fixtures/settlement/m22_scenario.json`
- `fixtures/settlement/m22_expected.json`
- `src/service/settlementActionsService.mjs`
- `scripts/run-m22-settlement-actions-from-store-scenario.mjs`
- Proof outputs under `artifacts/milestones/M22/latest/*`
