# M50 â€” Vault/settlement integration contract (fixtures-first)

## Objective
Integrate vault holdings into settlement start/terminal flows so cycles can run in mixed or fully-vaulted modes with deterministic constraints.

## Scope

### 1) Settlement start contract extension
Extend `SettlementStartRequest` with optional `vault_bindings[]` entries:
- `intent_id`
- `holding_id`
- `reservation_id`

### 2) Start-time vault binding validation + leg materialization
On `settlement.start`:
- validate each binding against cycle intent membership,
- validate holding existence + reserved state + reservation match,
- enforce holder ownership matches leg depositor,
- enforce holding asset matches leg asset set,
- reject bindings that are already bound to another cycle.

Bound legs are materialized as deposited:
- `deposit_mode = "vault"`
- `deposit_ref = "vault:<holding_id>:<reservation_id>"`
- `vault_holding_id`, `vault_reservation_id`, `deposited_at`

### 3) Mixed-mode + instant-ready semantics
- Mixed cycles are supported (some vault-bound, some manual deposits).
- If all legs are vault-bound/deposited at start, timeline transitions to `escrow.ready` immediately.
- Manual `settlement.deposit_confirmed` on vault-bound legs is rejected deterministically (`vault_backed_leg`).

### 4) Terminal reconciliation for bound holdings
- On `settlement.complete`: bound holdings become `withdrawn`, reservation cleared.
- On `settlement.expire_deposit_window` failure: bound holdings return to `available`, reservation cleared.
- Bound holding cycle lock (`settlement_cycle_id`) is cleared in terminal states.

### 5) Fixtures-first verifier
Scenario proves:
- partial vault binding can fail via timeout and returns bound holdings to `available`,
- malformed binding (`vault_reservation_mismatch`) blocks settlement start,
- full vault binding starts directly in `escrow.ready`,
- manual deposit on vault leg fails with `CONFLICT` + `vault_backed_leg`,
- complete path reconciles bound holdings to `withdrawn`.

## Acceptance criteria
- `npm run verify:m50` exits 0.
- `node verify/runner.ts milestones/M50.yaml` returns `overall=true`.
- artifacts exist under `artifacts/milestones/M50/latest/*`.
