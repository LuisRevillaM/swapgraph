# M4 — SwapIntent ingestion + validation + persistence (fixtures-first)

## Objective
Make the first piece of the developer preview **real and deterministic**:
- accept SwapIntents (create/update/cancel)
- enforce idempotency rules
- persist state and prove it can be reloaded

This milestone is deliberately **not an HTTP server** yet; it is a core engine with a fixtures-driven verifier.

## Scope
- Core SwapIntents service implementing:
  - create (`swapIntents.create`)
  - update (`swapIntents.update`)
  - cancel (`swapIntents.cancel`)
  - get (`swapIntents.get`)
  - list (`swapIntents.list`)
- Idempotency behavior per `docs/spec/IDEMPOTENCY.md`:
  - same key + same payload ⇒ replay same result
  - same key + different payload ⇒ deterministic conflict error
- JSON-file persistence store (for deterministic sandbox verification).
- Scenario runner that:
  - validates requests/responses against the API schemas,
  - executes a scenario fixture,
  - asserts summary matches expected output,
  - emits proof artifacts.

## Non-goals
- No matching engine.
- No cycle proposals.
- No real auth system (we only apply a minimal actor isolation rule in get/list for safety).

## Acceptance criteria
- `npm run verify:m4` exits 0.
- `node verify/runner.ts milestones/M4.yaml` exits 0.
- Artifacts exist at `artifacts/milestones/M4/latest/*`.

## Required artifacts
- Fixtures:
  - `fixtures/scenarios/m4_intents_scenario.json`
  - `fixtures/scenarios/m4_expected_results.json`
- Proof artifacts:
  - `artifacts/milestones/M4/latest/intent_ingestion_results.json`
  - `artifacts/milestones/M4/latest/intents_store_snapshot.json`
  - `artifacts/milestones/M4/latest/assertions.json`
  - `artifacts/milestones/M4/latest/commands.log`
