# M31 — Scope enforcement in services (fixtures-first) + `INSUFFICIENT_SCOPE` proofs

## Objective
Make the auth scope contract from M30 **real** by enforcing it inside the fixtures-first service layer.

M30 added:
- `docs/spec/AUTH.md` (scope taxonomy)
- per-endpoint `auth.required / allowed_actor_types / required_scopes` annotations in `docs/spec/api/manifest.v1.json`

M31 adds:
- a shared `authorizeApiOperation(...)` helper that reads the API manifest and enforces:
  - `auth.required`
  - `auth.allowed_actor_types`
  - `auth.required_scopes`
- deterministic proofs that missing scopes produce `INSUFFICIENT_SCOPE`.

## Scope
### 1) Authz helper (single source of truth)
Add `src/core/authz.mjs`:
- loads `docs/spec/api/manifest.v1.json`
- exposes `authorizeApiOperation({ operationId, actor, auth })`
- `auth` shape: `{ scopes: string[] }`

### 2) Enforcement points
Add an optional `auth` param to boundary services and enforce when enabled:
- `src/service/swapIntentsService.mjs`
- `src/read/cycleProposalsReadService.mjs`
- `src/commit/commitService.mjs`
- `src/service/settlementWriteApiService.mjs`
- `src/read/settlementReadService.mjs`

### 3) Enforcement mode flag
To avoid rewriting every historical verifier immediately, enforcement is gated behind:
- `AUTHZ_ENFORCE=1`

When `AUTHZ_ENFORCE` is not set, services keep legacy behavior.

### 4) Proof scenario
Add a deterministic scenario that runs with `AUTHZ_ENFORCE=1` and proves:
- missing required scope ⇒ `ErrorResponse.error.code = INSUFFICIENT_SCOPE`
- correct scope ⇒ success (schema-valid)

## Acceptance criteria
- `npm run verify:m31` exits 0.
- `node verify/runner.ts milestones/M31.yaml` exits 0.
- Artifacts captured under `artifacts/milestones/M31/latest/*`.

## Required artifacts
- `docs/prd/M31.md`
- `src/core/authz.mjs`
- proof scenario fixture(s) + script
- `verify/m31.sh`
- `milestones/M31.yaml`
