# M119 â€” Matching v2 canary cutover contract (small slice + automatic rollback)

## Objective
Enable a deterministic canary path where matching v2 can become the primary selector/writer for a bounded slice of traffic, with automatic fallback and rollback guards that keep marketplace matching safe by default.

## Scope
- Keep marketplace matching API request/response schemas unchanged.
- Add deterministic canary routing controls for v2 primary selection.
- Keep v1 available as immediate fallback for every canary run.
- Add automatic rollback state that deactivates further canary routing when guard thresholds are exceeded.
- Persist per-run canary decision/guard diagnostics for verification and operator review.
- Add a fixtures-first verifier proving:
  - successful v2 primary routing in canary mode,
  - forced v2 canary failure fallback to v1,
  - automatic rollback activation,
  - post-rollback canary suppression.

## Canary controls (M119)
- `MATCHING_V2_CANARY_ENABLED`
- `MATCHING_V2_CANARY_PERCENT_BPS`
- `MATCHING_V2_CANARY_SALT`
- `MATCHING_V2_CANARY_FORCE_BUCKET_V2` (test override)
- `MATCHING_V2_CANARY_FORCE_ERROR` (test override)

## Rollback controls (M119)
- `MATCHING_V2_CANARY_ROLLBACK_WINDOW_RUNS`
- `MATCHING_V2_CANARY_ROLLBACK_MAX_ERROR_RATE_BPS`
- `MATCHING_V2_CANARY_ROLLBACK_MAX_TIMEOUT_RATE_BPS`
- `MATCHING_V2_CANARY_ROLLBACK_MAX_LIMITED_RATE_BPS`
- `MATCHING_V2_CANARY_ROLLBACK_MIN_NON_NEGATIVE_DELTA_RATE_BPS`
- `MATCHING_V2_MAX_CANARY_DECISIONS`

## Non-goals (M119)
- No full v2 cutover.
- No API schema expansion for canary diagnostics.
- No TypeScript migration work.

## Acceptance criteria
- `npm run verify:m119` exits 0.
- `npm run verify:m118` exits 0 (shadow burn-in gate remains green).
- Deterministic proof artifacts exist at `artifacts/milestones/M119/latest/*`.

## Required artifacts
- `src/service/marketplaceMatchingService.mjs`
- `scripts/run-m119-matching-v2-canary-scenario.mjs`
- `fixtures/release/m119_scenario.json`
- `fixtures/release/m119_expected.json`
- `verify/m119.sh`
- `milestones/M119.yaml`
- `artifacts/milestones/M119/latest/matching_v2_canary_output.json`
- `artifacts/milestones/M119/latest/assertions.json`
- `artifacts/milestones/M119/latest/commands.log`
