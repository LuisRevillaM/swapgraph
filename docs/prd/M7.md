# M7 — Commit handshake v1 (accept/decline → ready) + reservation locks

## Objective
Implement the v2.0 plan’s **two-phase commit handshake** with verifiable invariants:
- Accept/decline are idempotent.
- On first accept, all intents in the proposal become reserved.
- Only one active reservation per intent.
- Once all participants accept, commit becomes `ready`.
- Decline cancels the commit and releases reservations.
- Critical state changes emit events into an append-only outbox.

## Scope
- Commit service implementing:
  - `cycleProposals.accept`
  - `cycleProposals.decline`
  - `commits.get`
- Reservation store (`reservations[intent_id] -> commit_id`), enforced conflict-free.
- Append-only event outbox (uses M3 envelope + payload schemas):
  - `intent.reserved`
  - `intent.unreserved`
  - `cycle.state_changed`
- Fixtures-first scenario that proves:
  - accept/decline schema validity,
  - idempotency replay,
  - reservation conflict,
  - ready transition,
  - decline releases reservations,
  - events validate and are replay-safe.

## Non-goals
- No settlement timeline yet.
- No receipts yet.

## Acceptance criteria
- `npm run verify:m7` exits 0.
- `node verify/runner.mjs milestones/M7.yaml` exits 0.
- Proof artifacts exist at `artifacts/milestones/M7/latest/*`.

## Required artifacts
Fixtures:
- `fixtures/commit/m7_scenario.json`
- `fixtures/commit/m7_expected.json`

Proof artifacts:
- `artifacts/milestones/M7/latest/commit_output.json`
- `artifacts/milestones/M7/latest/events_outbox.ndjson`
- `artifacts/milestones/M7/latest/events_validation.json`
- `artifacts/milestones/M7/latest/assertions.json`
- `artifacts/milestones/M7/latest/commands.log`
