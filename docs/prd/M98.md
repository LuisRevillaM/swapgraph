# M98 — API + event surface completion contracts (PRD-only, implementation-ready)

## Objective
Close remaining v2 illustrative API/event coverage gaps as explicit, deterministic contracts before any new feature expansion work.

## Scope
### A) API contract inventory (to define)
1. **Platform connections**
   - `platform.connections.list` → `GET /platform-connections`
   - `platform.connections.upsert` → `POST /platform-connections`
2. **Inventory surfaces**
   - `inventory.snapshots.record` → `POST /inventory/snapshots`
   - `inventory.assets.list` → `GET /inventory/assets`
3. **Disputes facade**
   - `disputes.create` → `POST /disputes`
   - `disputes.get` → `GET /disputes/{dispute_id}`

### B) Event contract inventory (to define)
- `proposal.cancelled`
- `cycle.failed`
- `user.reliability_changed`

### C) Contract requirements
- Schema definitions + examples + manifest entries.
- Auth scope requirements and allowed actor types per operation.
- Idempotency semantics for all mutating operations.
- Deterministic error reason-code matrix.
- Verifier scenario design requirements (for future implementation milestone execution).

## Proposed contract map (for approval)

### API operations
| Operation ID | Method/Path | Idempotency | Actors | Scopes | Notes |
|---|---|---:|---|---|---|
| `platform.connections.list` | `GET /platform-connections` | no | `user`, `partner` | `settlement:read` | list connected platforms + status metadata |
| `platform.connections.upsert` | `POST /platform-connections` | yes | `user`, `partner` | `settlement:write` | register/update connection metadata only (no live callback execution) |
| `inventory.snapshots.record` | `POST /inventory/snapshots` | yes | `partner` | `settlement:write` | deterministic inventory proof snapshot recording |
| `inventory.assets.list` | `GET /inventory/assets` | no | `partner`, `agent` | `settlement:read` | read normalized assets from snapshots with partner scoping |
| `disputes.create` | `POST /disputes` | yes | `partner` | `settlement:write` | canonical facade mapped to existing dispute domain model |
| `disputes.get` | `GET /disputes/{dispute_id}` | no | `partner` | `settlement:read` | deterministic read projection for dispute lifecycle state |

### Event types
| Event type | Payload schema (target) | Minimum payload fields |
|---|---|---|
| `proposal.cancelled` | `ProposalCancelledPayload.schema.json` | `proposal_id`, `cycle_id`, `reason_code`, `cancelled_at` |
| `cycle.failed` | `CycleFailedPayload.schema.json` | `cycle_id`, `from_state`, `reason_code`, `failed_at` |
| `user.reliability_changed` | `UserReliabilityChangedPayload.schema.json` | `user_id`, `from_tier`, `to_tier`, `reason_code`, `changed_at` |

## Disputes facade mapping strategy (proposed)
- `disputes.create` should map to existing partner dispute lifecycle semantics (currently under partner-program dispute contracts) to avoid semantic duplication.
- `disputes.get` provides the canonical read projection needed by v2 section 11 without introducing a second dispute store.
- Existing compensation/dispute-linkage contracts remain authoritative for post-resolution remediation chain.

## Proposed schema artifacts (naming target)
- `PlatformConnection.schema.json`
- `PlatformConnectionListResponse.schema.json`
- `PlatformConnectionUpsertRequest.schema.json`
- `PlatformConnectionUpsertResponse.schema.json`
- `InventorySnapshotRecordRequest.schema.json`
- `InventorySnapshotRecordResponse.schema.json`
- `InventoryAssetListResponse.schema.json`
- `DisputeCreateRequest.schema.json`
- `DisputeCreateResponse.schema.json`
- `DisputeGetResponse.schema.json`
- `ProposalCancelledPayload.schema.json`
- `CycleFailedPayload.schema.json`
- `UserReliabilityChangedPayload.schema.json`

## Deterministic error reason-code targets
- `platform_connection_invalid`
- `platform_connection_invalid_timestamp`
- `inventory_snapshot_invalid`
- `inventory_snapshot_invalid_timestamp`
- `inventory_asset_query_invalid`
- `dispute_facade_invalid`
- `dispute_not_found`

## PRD review closure matrix
| Decision | Proposal | Status |
|---|---|---|
| Scope model | Reuse existing scope families (`settlement:read/write`) for M98 to avoid auth-validator churn in PRD-only tranche | Pending approval |
| Dispute facade | Canonical facade operations map to existing dispute lifecycle semantics/store; no duplicate persistence model | Pending approval |
| Event ordering semantics | Preserve current event model: deterministic envelopes with at-least-once delivery and consumer dedupe by `event_id`; no global ordering guarantee | Pending approval |

## Non-goals (M98)
- No UI/client implementation.
- No live partner OAuth callback implementation details beyond contract definitions.
- No settlement execution behavior changes.
- No implementation work in this milestone until PRD approval is explicit.

## Acceptance (PRD stage)
- M98 PRD is accepted when:
  1. operation/event inventory is complete and non-overlapping,
  2. auth/idempotency model is fixed,
  3. dispute-facade mapping strategy is approved,
  4. event-ordering semantics are explicitly documented,
  5. reason-code taxonomy is accepted.

## Acceptance (future implementation stage)
- `npm run verify:m98` exits 0.
- `node verify/runner.ts milestones/M98.yaml` returns `overall=true`.
- Artifacts under `artifacts/milestones/M98/latest/*`.
