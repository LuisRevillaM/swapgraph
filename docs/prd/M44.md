# M44 â€” Stateful checkpoint continuity for delegated policy-audit export

## Objective
Harden paginated delegated policy-audit export continuation by enforcing that `checkpoint_after` references a valid prior checkpoint context, not just a hash-shaped value.

## Scope

### 1) Stateful checkpoint continuity (opt-in)
When `POLICY_AUDIT_EXPORT_CHECKPOINT_ENFORCE=1` and a continuation request is made (`cursor_after` present):
- `checkpoint_after` must exist in server checkpoint state.
- `cursor_after` must match prior checkpoint `next_cursor`.
- `attestation_after` must match prior checkpoint `attestation.chain_hash`.
- continuation query context must match prior checkpoint context:
  - `subject_actor_id`
  - `decision`
  - `operation_id`
  - `delegation_id`
  - `from_iso`
  - `to_iso`
  - `limit`

Deterministic reason codes in error details:
- `checkpoint_after_not_found`
- `checkpoint_cursor_mismatch`
- `checkpoint_attestation_mismatch`
- `checkpoint_query_mismatch`

### 2) Persist checkpoint context in store
Persist checkpoint metadata in `policy_audit_export_checkpoints` keyed by `checkpoint_hash` so continuation can be validated deterministically.

### 3) Fixtures-first verifier
Scenario proves:
- successful page-1 export and page-2 continuation,
- rejection for unknown checkpoint,
- rejection for cursor mismatch,
- rejection for attestation mismatch,
- rejection for query-context mismatch,
- tampered checkpoint hash fails offline verification.

## Acceptance criteria
- `npm run verify:m44` exits 0.
- `node verify/runner.ts milestones/M44.yaml` returns `overall=true`.
- artifacts exist in `artifacts/milestones/M44/latest/*`.
