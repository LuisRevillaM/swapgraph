# M120 â€” Matching v2 full-primary cutover contract with retained fallback

## Objective
Promote matching v2 to the primary selector/writer path for marketplace runs while retaining deterministic fallback and rollback safeguards.

## Scope
- Keep marketplace matching API request/response schemas unchanged.
- Add a full-primary mode (`MATCHING_V2_PRIMARY_ENABLED=1`) where v2 is attempted first on every eligible run.
- Retain v1 fallback behavior when v2 fails or hits safety triggers.
- Preserve rollback latch semantics from M119.
- Add explicit rollback reset/unlatch control (`MATCHING_V2_ROLLBACK_RESET=1`) and fixture proof.
- Persist deterministic per-run decision diagnostics in existing internal canary decision storage.

## Required fallback behavior (M120)
- v2 error fallback: if v2 primary execution throws, route to v1.
- v2 safety fallback: if v2 marks timeout/limited safety triggers and fallback controls are enabled, route to v1.
- Rollback latch: once rollback is activated, all new v2 attempts (primary and shadow) are suppressed until explicit reset.

## Controls (M120)
- `MATCHING_V2_PRIMARY_ENABLED`
- `MATCHING_V2_PRIMARY_FORCE_ERROR` (test-only deterministic force)
- `MATCHING_V2_PRIMARY_FORCE_SAFETY_TIMEOUT` (test-only deterministic force)
- `MATCHING_V2_PRIMARY_FORCE_SAFETY_LIMITED` (test-only deterministic force)
- `MATCHING_V2_FALLBACK_ON_TIMEOUT`
- `MATCHING_V2_FALLBACK_ON_LIMITED`
- `MATCHING_V2_ROLLBACK_RESET`

## Non-goals (M120)
- No API schema additions.
- No TypeScript migration behavior changes.
- No deployment automation changes.

## Acceptance criteria
- `npm run verify:m120` exits 0.
- `npm run verify:m119` exits 0.
- `npm run verify:m118` exits 0.
- Deterministic proof artifacts exist at `artifacts/milestones/M120/latest/*`.

## Required artifacts
- `src/service/marketplaceMatchingService.mjs`
- `scripts/run-m120-matching-v2-primary-scenario.mjs`
- `fixtures/release/m120_scenario.json`
- `fixtures/release/m120_expected.json`
- `verify/m120.sh`
- `milestones/M120.yaml`
- `artifacts/milestones/M120/latest/matching_v2_primary_output.json`
- `artifacts/milestones/M120/latest/assertions.json`
- `artifacts/milestones/M120/latest/commands.log`
