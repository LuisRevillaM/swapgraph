# M40 â€” Consent proof binding + delegated policy audit pagination/retention hardening

## Objective
Harden delegated high-value consent handling and the delegated policy audit read contract by:
1) binding consent proofs to concrete action context, and
2) adding deterministic pagination + retention behavior to policy-audit reads.

## Scope

### 1) Consent proof binding (opt-in)
Extend high-value consent checks with proof binding enforcement:
- controlled by `POLICY_CONSENT_PROOF_BIND_ENFORCE=1`
- proof binding derives expected proof from:
  - `consent_id`
  - delegated subject actor
  - delegation id
  - intent id
  - intent max_usd
- mismatch returns deterministic `consent_proof_mismatch`

This is layered on top of existing tier enforcement (`POLICY_CONSENT_TIER_ENFORCE=1`).

### 2) Delegated policy audit list contract hardening
Enhance `GET /policy-audit/delegated-writes` behavior:
- pagination: `limit`, `cursor_after` and response `next_cursor`
- filters: `decision`, `operation_id`, `delegation_id`, `from_iso`, `to_iso`
- response metadata: `total_filtered`
- retention-window filtering:
  - deterministic `now_iso` query override
  - retention horizon via `POLICY_AUDIT_RETENTION_DAYS`

### 3) API/schema updates
- `PolicyAuditListResponse` gains optional `next_cursor` + `total_filtered`
- update API examples and manifest coverage for contract validation

### 4) Proof scenario
Deterministic proof validates:
- consent proof mismatch denies high-value writes
- bound consent proof allows high-value writes
- tier insufficiency still enforced for higher-value actions
- policy-audit list pagination works over filtered set
- retention excludes older audit events
- user-only audit read access still enforced

## Acceptance criteria
- `npm run verify:m40` exits 0.
- `node verify/runner.mjs milestones/M40.yaml` overall=true.
- artifacts under `artifacts/milestones/M40/latest/*`.
