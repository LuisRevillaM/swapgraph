# M64 â€” Rollout diagnostics automation hints (fixtures-first)

## Objective
Add deterministic, signed automation planning hints to `partnerProgram.vault_export.rollout_policy.diagnostics.export` so operators can convert diagnostics outputs into safe, bounded runbook actions.

## Scope

### 1) Diagnostics query controls for automation hints
Extend diagnostics export query controls with:
- `include_automation_hints` (boolean, default false)
- `automation_max_actions` (integer, range `1..10`, default `2`)

Invalid automation controls must return deterministic contract errors:
- `CONSTRAINT_VIOLATION`
- `reason_code=partner_rollout_diagnostics_automation_invalid`

### 2) Signed automation hint payload
When `include_automation_hints=true`, include signed `automation_hints` payload:
- `requires_operator_confirmation` (boolean)
- `source_alert_codes[]`
- `action_queue[]` entries:
  - `hook_id` (`disable_maintenance_mode|clear_freeze_window|clear_controls|observe_only`)
  - `reason_code` (`maintenance_mode_active|freeze_window_active|no_action_required`)
  - `priority` (`high|normal`)
- `safety`:
  - `idempotency_required` (boolean)
  - `max_actions_per_run` (integer)

### 3) Deterministic action queue construction
Generate `action_queue` deterministically from existing diagnostics recommendations/alerts:
- dedupe by `hook_id`
- exclude passive-only recommendation (`observe_only`) from actionable queue
- cap queue length to `automation_max_actions`
- emit high priority for active control hazards (maintenance/freeze), normal otherwise

### 4) Integrity coverage updates
Include automation-hints query knobs and payload in diagnostics export hash/signature normalization + verification paths so tampering is detected by both private/public verification helpers.

### 5) Contract/docs updates
Update API/docs/schema/example coverage for:
- new query fields (`include_automation_hints`, `automation_max_actions`)
- new response field (`automation_hints`)
- new reason code (`partner_rollout_diagnostics_automation_invalid`)

### 6) Fixtures-first verifier
Add M64 deterministic scenario proving:
- automation hints returned and signed when requested
- bounded queue behavior for max-actions 1 and 2
- automation hints empty/no-action after controls are cleared
- invalid `automation_max_actions` rejection reason code
- signed export verify pass + tamper-fail detection
- continuity checkpoint records include automation query context

## Acceptance criteria
- `npm run verify:m64` exits 0.
- `node verify/runner.mjs milestones/M64.yaml` returns `overall=true`.
- artifacts exist under `artifacts/milestones/M64/latest/*`.
