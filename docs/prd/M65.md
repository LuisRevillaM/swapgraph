# M65 â€” Rollout diagnostics automation action-request templates (fixtures-first)

## Objective
Harden rollout diagnostics automation guidance by emitting deterministic, signed admin-action request templates (`action_requests`) and enforcing that automation hints are only produced when runbook hooks are included.

## Scope

### 1) Automation hints: deterministic action request templates
Extend `automation_hints` with `action_requests[]` aligned to `action_queue[]`:
- `step` (1-based deterministic order)
- `hook_id`
- `operation_id` (fixed: `partnerProgram.vault_export.rollout_policy.admin_action`)
- `idempotency_key_template` (deterministic template)
- `request.action` payload template for admin-action execution

### 2) Automation safety metadata
Extend `automation_hints.safety` with:
- `idempotency_scope` (`partnerProgram.vault_export.rollout_policy.admin_action`)
- existing `idempotency_required`
- existing `max_actions_per_run`

### 3) Contract guardrail for automation context completeness
When `include_automation_hints=true`, require `include_runbook_hooks=true`.

Deterministic violation contract:
- `CONSTRAINT_VIOLATION`
- `reason_code=partner_rollout_diagnostics_automation_requires_runbook_hooks`

### 4) Integrity coverage
Ensure new automation template fields (`action_requests`, `idempotency_scope`) are normalized into diagnostics export signable payload + hash/signature verification paths.

### 5) Docs/contracts
Update diagnostics response schema/examples and API/ERROR docs for:
- `automation_hints.action_requests[]`
- `automation_hints.safety.idempotency_scope`
- `partner_rollout_diagnostics_automation_requires_runbook_hooks`

### 6) Fixtures-first verifier
Scenario proves:
- signed deterministic `action_requests` for `automation_max_actions=1` and `2`
- continuation compatibility with automation templates preserved
- deterministic guardrail rejection when automation hints are requested with runbook hooks disabled
- clear-controls state produces empty queue/templates but preserves safety scope
- tamper-fail verification remains enforced

## Acceptance criteria
- `npm run verify:m65` exits 0.
- `node verify/runner.ts milestones/M65.yaml` returns `overall=true`.
- artifacts exist under `artifacts/milestones/M65/latest/*`.
