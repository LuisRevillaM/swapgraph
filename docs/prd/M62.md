# M62 â€” Rollout diagnostics export continuity + checkpoint retention hardening (fixtures-first)

## Objective
Harden `partnerProgram.vault_export.rollout_policy.diagnostics.export` with deterministic continuation integrity and checkpoint-retention controls, aligned with existing signed export-chain patterns used for settlement and rollout-policy audit exports.

## Scope

### 1) Signed diagnostics export continuity primitives
Extend diagnostics export payload to support deterministic continuation:
- signed `attestation` chain (`page_hash` + `chain_hash`)
- optional signed `checkpoint` anchors (`checkpoint_hash`)

Continuation parameters:
- `attestation_after`
- `checkpoint_after` (when checkpoint mode is enforced)

### 2) Stateful diagnostics checkpoint continuation validation
When diagnostics checkpoint enforcement is enabled (`PARTNER_PROGRAM_ROLLOUT_POLICY_DIAGNOSTICS_EXPORT_CHECKPOINT_ENFORCE=1`):
- continuation with `attestation_after` requires `checkpoint_after`
- validate checkpoint existence, attestation-chain lock, and query-context lock

Deterministic reason codes:
- `checkpoint_after_not_found`
- `checkpoint_attestation_mismatch`
- `checkpoint_query_mismatch`

### 3) Diagnostics checkpoint retention + expiry
Add retention controls for diagnostics export checkpoints:
- env: `PARTNER_PROGRAM_ROLLOUT_POLICY_DIAGNOSTICS_EXPORT_CHECKPOINT_RETENTION_DAYS`
- deterministic expiry failure reason code: `checkpoint_expired`
- opportunistic pruning of expired diagnostics checkpoint anchors

### 4) Contract + docs updates
- update diagnostics export response schema with query continuation params + optional `attestation`/`checkpoint`
- include diagnostics checkpoint overlay observability in diagnostics payload:
  - `rollout_policy_diagnostics_checkpoint_enforced`
  - `rollout_policy_diagnostics_checkpoint_retention_days`
- update API/ERROR docs to document diagnostics continuation + retention behavior

### 5) Fixtures-first verifier
Scenario proves:
- non-admin diagnostics export rejection remains deterministic
- diagnostics page-1 + continuation page-2 success with attestation/checkpoint chaining
- missing checkpoint rejection under enforced mode
- deterministic failures for not-found/attestation/query mismatch
- deterministic expiry rejection after retention window
- compact diagnostics export mode (no recommendations/hooks) remains signed/verifiable
- tamper-fail signature/hash verification remains enforced

## Acceptance criteria
- `npm run verify:m62` exits 0.
- `node verify/runner.mjs milestones/M62.yaml` returns `overall=true`.
- artifacts exist under `artifacts/milestones/M62/latest/*`.
