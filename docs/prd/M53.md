# M53 â€” Vault reconciliation export pagination + checkpoint continuity hardening (fixtures-first)

## Objective
Harden partner vault reconciliation exports for large cycles by adding deterministic pagination continuity contracts:
1) signed attestation chaining across export pages, and
2) stateful checkpoint continuation validation for partner exports.

## Scope

### 1) Pagination contract for vault reconciliation export
Extend:
- `GET /settlement/{cycle_id}/vault-reconciliation/export`

Add optional query parameters:
- `limit`
- `cursor_after`
- `attestation_after`
- `checkpoint_after` (when checkpoint mode is enabled)

Pagination applies to `vault_reconciliation.entries` while preserving cycle-level reconciliation summary and signed payload integrity.

### 2) Signed attestation continuity
When pagination is used:
- response includes `total_filtered` and optional `next_cursor`
- response includes signed `attestation`:
  - `cursor_after`
  - `next_cursor`
  - `attestation_after`
  - `page_hash`
  - `chain_hash`

Continuation rules:
- `cursor_after` requires `attestation_after`
- `attestation_after` is invalid without `cursor_after`

### 3) Stateful checkpoint continuity (opt-in)
When `SETTLEMENT_VAULT_EXPORT_CHECKPOINT_ENFORCE=1`:
- continuation (`cursor_after`) also requires `checkpoint_after`
- `checkpoint_after` is invalid without `cursor_after`
- `checkpoint_after` must reference an existing checkpoint record
- continuation must match prior checkpoint context:
  - expected `next_cursor`
  - expected `attestation_chain_hash`
  - query context fingerprint (`cycle_id`, `include_transitions`, `limit`)

Deterministic reason codes:
- `checkpoint_after_not_found`
- `checkpoint_cursor_mismatch`
- `checkpoint_attestation_mismatch`
- `checkpoint_query_mismatch`

### 4) Signing/verification extensions
Extend settlement vault export signing helpers to support:
- paginated export hash inputs (`total_filtered`, `next_cursor`)
- signed attestation verification
- signed checkpoint verification
- tamper-fail proof (`checkpoint_hash_mismatch`)

### 5) Fixtures-first verifier
Scenario proves:
- page-1/page-2 export chain validates with signed payload verification,
- public-key verification remains valid,
- unknown checkpoint is rejected,
- cursor mismatch is rejected,
- attestation mismatch is rejected,
- query-context mismatch is rejected,
- malformed attestation query states are rejected,
- tampered checkpoint fails deterministic verification.

## Acceptance criteria
- `npm run verify:m53` exits 0.
- `node verify/runner.ts milestones/M53.yaml` returns `overall=true`.
- artifacts exist under `artifacts/milestones/M53/latest/*`.
