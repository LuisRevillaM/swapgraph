# M101 — Product-surface readiness contracts (implemented, fixtures-first)

## Objective
Convert product-surface readiness discovery outputs into deterministic API contracts that unblock web, iOS, and embedded partner UI client work against stable shared projections.

## Scope
### A) Notification and preference contracts
1. `notifications.preferences.get` → `GET /notifications/preferences`
2. `notifications.preferences.upsert` → `POST /notifications/preferences`
3. `notifications.inbox.list` → `GET /notifications/inbox`

Notification taxonomy floor (implemented):
- `proposal.created`
- `proposal.expiring`
- `settlement.deposit_required`
- `settlement.deposit_deadline_approaching`
- `cycle.executing`
- `cycle.completed`
- `cycle.failed`
- `refund.completed`
- `intent.demand_signal`

Preference controls floor (implemented):
- quiet-hours window
- urgency threshold
- category-level opt in/out
- demand-signal opt in/out

### B) Product projection contracts
1. `productProjection.inventory_awakening.get` → `GET /product-projections/inventory-awakening`
2. `productProjection.cycle_inbox.list` → `GET /product-projections/cycle-inbox`
3. `productProjection.settlement_timeline.get` → `GET /product-projections/settlement-timeline/{cycle_id}`
4. `productProjection.receipt_share.get` → `GET /product-projections/receipt-share/{receipt_id}`

Projection field floor (implemented):
- inventory awakening: swappability summary + recommended first intents
- cycle inbox cards: give/get, confidence, explainability, deadline, fee summary
- settlement timeline digest: user-facing state and next required action
- receipt share card: public-safe metadata + privacy toggle controls

### C) Embedded partner UI payload contracts
1. `partnerUi.bundle.get` → `GET /partner-ui/bundles/{surface}`
2. `partnerUi.capabilities.get` → `GET /partner-ui/capabilities`

Surface set floor (implemented):
- intent composer
- cycle proposal cards
- settlement checklist
- receipt renderer

## Contract map (approved and implemented)
| Operation ID | Method/Path | Idempotency | Actors | Scopes | Notes |
|---|---|---:|---|---|---|
| `notifications.preferences.get` | `GET /notifications/preferences` | no | `user`, `partner` | `settlement:read` | returns actor notification controls |
| `notifications.preferences.upsert` | `POST /notifications/preferences` | yes | `user`, `partner` | `settlement:write` | deterministic preference updates |
| `notifications.inbox.list` | `GET /notifications/inbox` | no | `user`, `partner` | `settlement:read` | anti-spam inbox projection |
| `productProjection.inventory_awakening.get` | `GET /product-projections/inventory-awakening` | no | `user`, `partner` | `settlement:read` | discovery/start-flow projection |
| `productProjection.cycle_inbox.list` | `GET /product-projections/cycle-inbox` | no | `user`, `partner` | `settlement:read` | proposal inbox projection |
| `productProjection.settlement_timeline.get` | `GET /product-projections/settlement-timeline/{cycle_id}` | no | `user`, `partner` | `settlement:read` | state-machine digest projection |
| `productProjection.receipt_share.get` | `GET /product-projections/receipt-share/{receipt_id}` | no | `user`, `partner` | `receipts:read` | share-card safe payload |
| `partnerUi.bundle.get` | `GET /partner-ui/bundles/{surface}` | no | `partner` | `settlement:read` | embeddable payload contract |
| `partnerUi.capabilities.get` | `GET /partner-ui/capabilities` | no | `partner` | `settlement:read` | supported surfaces/version matrix |

## Contract constraints
- Preference writes are idempotent and deterministic.
- Notification taxonomy remains anti-spam by default (quiet-hours + urgency threshold gate).
- Projection payloads are client-agnostic (no client-specific endpoint forks).
- Embedded payload contracts keep capability discovery separate from bundle retrieval.

## Implemented schema artifacts
- `NotificationPreferencesGetResponse.schema.json`
- `NotificationPreferencesUpsertRequest.schema.json`
- `NotificationPreferencesUpsertResponse.schema.json`
- `NotificationInboxListResponse.schema.json`
- `InventoryAwakeningProjectionResponse.schema.json`
- `CycleInboxProjectionListResponse.schema.json`
- `SettlementTimelineDigestResponse.schema.json`
- `ReceiptShareProjectionResponse.schema.json`
- `PartnerUiBundleGetResponse.schema.json`
- `PartnerUiCapabilitiesGetResponse.schema.json`

## Deterministic reason-code floor (implemented)
- `notification_preferences_invalid`
- `notification_preferences_invalid_timestamp`
- `notification_inbox_query_invalid`
- `product_projection_query_invalid`
- `settlement_timeline_not_found`
- `receipt_share_not_found`
- `partner_ui_surface_unknown`

## PRD review closure matrix
| Decision | Proposal | Status |
|---|---|---|
| Notification floor | Use taxonomy set above as v1 required events | Approved + implemented |
| Anti-spam defaults | Quiet-hours + urgency threshold mandatory fields in preferences | Approved + implemented |
| Projection boundaries | Enforce client-agnostic projection contracts (no client-specific forks) | Approved + implemented |
| Embedded mode boundaries | Separate capability discovery from payload retrieval | Approved + implemented |
| Scope model | Reuse existing scopes (`settlement:read/write`, `receipts:read`) for first tranche | Approved + implemented (scope-migration gate retained pre-external rollout) |

## Non-goals (M101)
- No web marketplace implementation.
- No iOS client implementation.
- No embedded SDK implementation.
- No dedicated new scope family rollout in this tranche.

## Acceptance (implementation stage)
- `npm run verify:m101` exits 0.
- `node verify/runner.mjs milestones/M101.yaml` returns `overall=true`.
- Artifacts under `artifacts/milestones/M101/latest/*`.
