# M101 — Product-surface readiness contracts (PRD-only, discovery-first)

## Objective
Define the contract layer required by web marketplace, iOS reference client, and embedded partner UI so official client-side development has stable API targets.

## Scope
### A) Notification and preference contracts (to define)
1. `notifications.preferences.get` → `GET /notifications/preferences`
2. `notifications.preferences.upsert` → `POST /notifications/preferences`
3. `notifications.inbox.list` → `GET /notifications/inbox`

Notification taxonomy floor (aligned to v2 Appendix E/F):
- `proposal.created`
- `proposal.expiring`
- `settlement.deposit_required`
- `settlement.deposit_deadline_approaching`
- `cycle.executing`
- `cycle.completed`
- `cycle.failed`
- `refund.completed`
- `intent.demand_signal`

Preference controls floor:
- quiet-hours window
- urgency threshold
- category-level opt in/out
- demand-signal opt in/out

### B) Product projection contracts (to define)
1. `productProjection.inventory_awakening.get` → `GET /product-projections/inventory-awakening`
2. `productProjection.cycle_inbox.list` → `GET /product-projections/cycle-inbox`
3. `productProjection.settlement_timeline.get` → `GET /product-projections/settlement-timeline/{cycle_id}`
4. `productProjection.receipt_share.get` → `GET /product-projections/receipt-share/{receipt_id}`

Projection field floor:
- inventory awakening: swappability summary + recommended first intents
- cycle inbox cards: give/get, confidence, explainability, deadline, fee summary
- settlement timeline digest: user-facing state and next required action
- receipt share card: public-safe metadata + privacy toggle controls

### C) Embedded partner UI payload contracts (to define)
1. `partnerUi.bundle.get` → `GET /partner-ui/bundles/{surface}`
2. `partnerUi.capabilities.get` → `GET /partner-ui/capabilities`

Surface set floor:
- intent composer
- cycle proposal cards
- settlement checklist
- receipt renderer

## Proposed contract map (for approval)
| Operation ID | Method/Path | Idempotency | Actors | Scopes | Notes |
|---|---|---:|---|---|---|
| `notifications.preferences.get` | `GET /notifications/preferences` | no | `user`, `partner` | `settlement:read` | returns user/partner notification controls |
| `notifications.preferences.upsert` | `POST /notifications/preferences` | yes | `user`, `partner` | `settlement:write` | deterministic preference updates |
| `notifications.inbox.list` | `GET /notifications/inbox` | no | `user`, `partner` | `settlement:read` | notification inbox projection |
| `productProjection.inventory_awakening.get` | `GET /product-projections/inventory-awakening` | no | `user`, `partner` | `settlement:read` | discovery/start-flow projection |
| `productProjection.cycle_inbox.list` | `GET /product-projections/cycle-inbox` | no | `user`, `partner` | `settlement:read` | proposal inbox projection |
| `productProjection.settlement_timeline.get` | `GET /product-projections/settlement-timeline/{cycle_id}` | no | `user`, `partner` | `settlement:read` | state-machine digest projection |
| `productProjection.receipt_share.get` | `GET /product-projections/receipt-share/{receipt_id}` | no | `user`, `partner` | `receipts:read` | share-card safe payload |
| `partnerUi.bundle.get` | `GET /partner-ui/bundles/{surface}` | no | `partner` | `settlement:read` | embeddable payload contract |
| `partnerUi.capabilities.get` | `GET /partner-ui/capabilities` | no | `partner` | `settlement:read` | supported surfaces/version matrix |

## Contract constraints
- Preference writes must be idempotent and deterministic.
- Notification taxonomy must remain anti-spam by design (quiet-hours + urgency gate required).
- Projection payloads must be client-agnostic and avoid per-client endpoint divergence.
- Embedded payload contracts must support API-only and UI-embedded integration modes.

## Proposed schema artifacts (naming target)
- `NotificationPreferencesGetResponse.schema.json`
- `NotificationPreferencesUpsertRequest.schema.json`
- `NotificationPreferencesUpsertResponse.schema.json`
- `NotificationInboxListResponse.schema.json`
- `InventoryAwakeningProjectionResponse.schema.json`
- `CycleInboxProjectionListResponse.schema.json`
- `SettlementTimelineDigestResponse.schema.json`
- `ReceiptShareProjectionResponse.schema.json`
- `PartnerUiBundleGetResponse.schema.json`
- `PartnerUiCapabilitiesGetResponse.schema.json`

## Deterministic reason-code floor (proposed)
- `notification_preferences_invalid`
- `notification_preferences_invalid_timestamp`
- `notification_inbox_query_invalid`
- `product_projection_query_invalid`
- `settlement_timeline_not_found`
- `receipt_share_not_found`
- `partner_ui_surface_unknown`

## PRD review closure matrix
| Decision | Proposal | Status |
|---|---|---|
| Notification floor | Use taxonomy set above as v1 required events | Pending approval |
| Anti-spam defaults | Quiet-hours + urgency threshold mandatory fields in preferences | Pending approval |
| Projection boundaries | Enforce client-agnostic projection contracts (no client-specific forks) | Pending approval |
| Embedded mode boundaries | Separate capability discovery from payload retrieval | Pending approval |
| Scope model | Reuse existing scopes (`settlement:read/write`, `receipts:read`) for first tranche | Pending approval |

## Upstream BRD/discovery dependencies
- BRD-01 KPI priorities: `docs/brd/2026-02-21_BRD-01_business-outcomes-kpi-bands.md`
- Web-first discovery briefs D-W1..D-W5: `docs/prd/2026-02-21_web-first-discovery-brief-pack_D-W1-D-W5.md`

## Non-goals (M101)
- No web marketplace implementation.
- No iOS client implementation.
- No embedded SDK implementation.
- No implementation work in this milestone until PRD approval is explicit.

## Acceptance (PRD stage)
- M101 PRD is accepted when:
  1. notification taxonomy and preference model are approved,
  2. projection payload contract inventory is explicit,
  3. embedded partner UI contract boundaries are approved,
  4. open decisions have explicit approvals/deferrals.

## Acceptance (future implementation stage)
- `npm run verify:m101` exits 0.
- `node verify/runner.ts milestones/M101.yaml` returns `overall=true`.
- Artifacts under `artifacts/milestones/M101/latest/*`.
