# M35 â€” Signed delegation token format + header parsing (fixtures-first)

## Objective
Move from passing `auth.delegation` objects directly in fixtures to a more realistic integration shape:
- users obtain a **delegation token** from SwapGraph
- agents authenticate via `Authorization: Bearer <delegation_token>`
- server-side middleware parses + verifies the token and produces `{ actor, auth }`

This milestone defines a stable **token format**, adds deterministic **Ed25519 signing**, and adds a fixtures-first **auth header parser**.

## Scope

### 1) Delegation token format (v1)
Define a bearer token format:
- Prefix: `sgdt1.`
- Payload: base64url(canonical_json(DelegationToken))

Where `DelegationToken` is:
```json
{
  "delegation": { /* DelegationGrant */ },
  "signature": { "key_id": "...", "alg": "ed25519", "sig": "..." }
}
```

Signature input bytes:
- canonical_json(token_without_signature)

Notes:
- `delegation.revoked_at` MUST NOT be required for token validity. Revocation is enforced server-side via persisted state.

### 2) Token signing keys (dev fixtures)
Add a non-production Ed25519 keypair:
- `fixtures/keys/delegation_token_signing_dev_dt_k1_{public,private}.pem`

Key id:
- `dev-dt-k1`

### 3) Delegations API responses include token
Update delegation responses to include a token string:
- `delegations.create` response includes `delegation_token`
- `delegations.get` response includes `delegation_token`
- `delegations.revoke` response includes `delegation_token`

This makes it possible for a user to retrieve and share the token without an additional endpoint.

### 4) Header parsing / auth middleware (fixtures-first)
Add `src/core/authHeaders.mjs`:
- parses `Authorization: Bearer ...`
- recognizes `sgdt1.` delegation tokens
- verifies signature
- returns `{ ok, actor, auth }` where:
  - `actor = delegation.principal_agent`
  - `auth.delegation = delegation`
  - `auth.now_iso` may be supplied via `X-Now-Iso` for deterministic expiry checks

### 5) Proof scenario
Add a deterministic verifier scenario proving:
- `delegations.create` returns a `delegation_token`
- middleware parses + verifies it
- agent can perform an allowed read operation using the derived `{actor, auth}`
- tampering the token fails verification
- revocation persistence still blocks the agent even if the original token is presented

## Acceptance criteria
- `npm run verify:m35` exits 0.
- `node verify/runner.ts milestones/M35.yaml` overall=true.
- Proof artifacts under `artifacts/milestones/M35/latest/*`.
