# M41 â€” Consent proof signature contract + delegated policy-audit export integrity

## Objective
Harden delegated high-value authorization and audit portability by adding:
1) **signed consent proofs** (in addition to binding), and
2) **signed delegated policy-audit exports** for offline integrity verification.

## Scope

### 1) Signed consent proof contract (opt-in)
Extend high-value consent checks when all controls are enabled:
- `POLICY_CONSENT_TIER_ENFORCE=1`
- `POLICY_CONSENT_PROOF_BIND_ENFORCE=1`
- `POLICY_CONSENT_PROOF_SIG_ENFORCE=1`

`auth.user_consent.consent_proof` must be a signed token (`sgcp2.<base64url-json>`) that verifies:
- signature validity against published policy-integrity keys,
- binding match (`consent_id`, subject actor, delegation id, intent id, intent max_usd),
- optional expiry validity.

Deterministic reason-codes are required for:
- signature required,
- signature invalid,
- binding mismatch,
- proof expired,
- malformed proof payload.

### 2) Policy-integrity key publication
Add public key contract:
- `GET /keys/policy-integrity-signing`

Response includes:
- `active_key_id`
- keys with statuses (`active`, `verify_only`)

### 3) Delegated audit export contract
Add signed export endpoint:
- `GET /policy-audit/delegated-writes/export`

Behavior:
- same filters as list endpoint (no pagination params)
- user-only, self-only access
- response includes:
  - `entries`
  - `total_filtered`
  - `query` (normalized export filter context)
  - `export_hash` (canonical SHA-256 over query+entries+total)
  - `signature` (policy-integrity signing key)

### 4) Fixtures-first proof scenario
Deterministic scenario validates:
- signature-required fail for plain bound proof under signature-enforced mode,
- signed proof mismatch/invalid/expired failures,
- signed bound proof success,
- tier checks remain intact,
- export signatures/hash verify (including public-key verification),
- tampered export hash fails verification,
- export access remains user-only.

## Acceptance criteria
- `npm run verify:m41` exits 0.
- `node verify/runner.mjs milestones/M41.yaml` returns `overall=true`.
- Artifacts are written under `artifacts/milestones/M41/latest/*`.
