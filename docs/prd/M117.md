# M117 â€” Matching v2 shadow mode (bounded, deterministic, no API contract change)

## Objective
Introduce a shadow-only matching v2 execution path that runs in parallel with v1, emits internal diff metrics, and keeps v1 as the sole proposal writer/selector.

## Scope
- Keep marketplace matching API responses unchanged.
- Keep v1 (`min=2,max=3`) as the only authoritative run used for persisted proposals.
- Add v2 shadow execution behind `MATCHING_V2_SHADOW=1` (default off).
- Add bounded shadow controls:
  - `MATCHING_V2_LMAX`/`MATCHING_V2_MAX_CYCLE_LENGTH`,
  - `MATCHING_V2_MAX_CYCLES_EXPLORED`,
  - `MATCHING_V2_TIMEOUT_MS`.
- Emit internal per-run shadow diff metrics:
  - `v2_candidate_cycles`,
  - `v2_selected_proposals`,
  - `v1_vs_v2_overlap`,
  - `delta_score_sum`,
  - runtime metrics.
- Prove deterministic shadow structural metrics for the same input snapshot.

## Non-goals (M117)
- No v2 cutover as primary selector/writer.
- No marketplace matching request/response schema changes.
- No settlement/auth harness migration changes.

## Acceptance criteria
- `npm run verify:m117:local` exits 0 (Track B-local behavior and determinism).
- `npm run verify:m117` exits 0.
- `npm run verify:m111` exits 0.
- `npm run verify:m114` exits 0.
- Proof artifacts exist at `artifacts/milestones/M117/latest/*`.

## Required artifacts
- `src/service/marketplaceMatchingService.mjs`
- `src/matching/engine.mjs`
- `src/matching/cycles.mjs`
- `scripts/run-m117-matching-v2-shadow-scenario.mjs`
- `fixtures/release/m117_scenario.json`
- `fixtures/release/m117_expected.json`
- `artifacts/milestones/M117/latest/matching_v2_shadow_output.json`
- `artifacts/milestones/M117/latest/assertions.json`
- `artifacts/milestones/M117/latest/commands.log`
