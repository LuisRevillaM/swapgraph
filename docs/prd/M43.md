# M43 â€” Consent challenge context + export checkpoint compaction

## Objective
Harden delegated high-value authorization and export continuity by adding:
1) challenge-context enforcement for signed consent proofs, and
2) checkpoint compaction anchors for paginated signed policy-audit exports.

## Scope

### 1) Consent challenge context (opt-in)
When enabled (`POLICY_CONSENT_PROOF_CHALLENGE_ENFORCE=1`) and signature/binding enforcement is active:
- `auth.user_consent.challenge_id` is required,
- signed consent proof (`sgcp2`) must include:
  - `challenge_id`
  - `challenge_binding`
- challenge binding is deterministic and bound to operation + intent context.

Deterministic reason-codes:
- `consent_challenge_required`
- `consent_proof_challenge_required`
- `consent_proof_challenge_mismatch`
- `consent_proof_challenge_config_invalid`

### 2) Export checkpoint compaction (opt-in)
When enabled (`POLICY_AUDIT_EXPORT_CHECKPOINT_ENFORCE=1`):
- paginated export continuation (`cursor_after`) requires:
  - `attestation_after` and
  - `checkpoint_after`
- export response includes signed `checkpoint` object:
  - `checkpoint_after`
  - `attestation_chain_hash`
  - `next_cursor`
  - `entries_count`
  - `total_filtered`
  - `checkpoint_hash`

Checkpoint hash provides compact chain anchor for long pagination runs.

### 3) Contracts/docs
- update export schema + example to include checkpoint fields,
- document challenge controls and checkpoint continuation semantics.

### 4) Fixtures-first proof
Scenario validates:
- missing challenge denied,
- missing proof challenge fields denied,
- mismatched proof challenge denied,
- valid challenge-bound signed proof succeeds,
- paginated export checkpoint chain continuity validates,
- tampered checkpoint hash fails verification,
- malformed continuation query states rejected,
- user-only export access preserved.

## Acceptance criteria
- `npm run verify:m43` exits 0.
- `node verify/runner.ts milestones/M43.yaml` returns `overall=true`.
- artifacts are written under `artifacts/milestones/M43/latest/*`.
