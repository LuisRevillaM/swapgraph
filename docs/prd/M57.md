# M57 â€” Partner-program admin rollout mutation surfaces + signed policy-audit export (fixtures-first)

## Objective
Add deterministic admin-governed controls for vault export rollout policy, with an auditable and signed export surface for policy-change history.

## Scope

### 1) Rollout policy admin write surface
Introduce idempotent write API:
- `POST /partner-program/vault-export/rollout-policy`
- operation: `partnerProgram.vault_export.rollout_policy.upsert`

Behavior:
- Partner-authenticated + scope-gated (`settlement:write`).
- Additional admin gate via `PARTNER_PROGRAM_ADMIN_ALLOWLIST` (default `ops-admin`).
- Stores canonical policy for `vault_reconciliation_export`:
  - `allowlist[]`
  - `min_plan_id` (`starter|pro|enterprise|null`)
  - metadata (`version`, `updated_at`, `updated_by`)
- Deterministic audit entry per successful mutation.
- Idempotency replay and mismatch rules consistent with existing mutation surfaces.

Deterministic reason codes:
- `partner_admin_required`
- `partner_rollout_allowlist_invalid`
- `partner_rollout_min_plan_invalid`

### 2) Rollout policy read surface
Introduce read API:
- `GET /partner-program/vault-export/rollout-policy`
- operation: `partnerProgram.vault_export.rollout_policy.get`

Returns effective policy view with source (`env` vs `store`) and version metadata.

### 3) Signed rollout policy-audit export
Introduce read export API:
- `GET /partner-program/vault-export/rollout-policy-audit/export`
- operation: `partnerProgram.vault_export.rollout_policy_audit.export`

Behavior:
- Partner-authenticated + admin-gated.
- Supports deterministic filtering/pagination (`from_iso`, `to_iso`, `limit`, `cursor_after`).
- Returns signed export payload (`export_hash` + detached signature), including current policy snapshot and matching audit entries.
- Supports offline verification and tamper-fail checks.

### 4) Rollout-policy resolution integration
Refactor settlement vault-export rollout evaluation to use shared policy resolver:
- Prefers persisted rollout policy state when present.
- Falls back to existing env hooks when state is absent.

### 5) Fixtures-first verifier
Scenario proves:
- non-admin mutation denied,
- admin mutation succeeds,
- idempotency replay and mismatch behavior,
- read policy reflects persisted versioned state,
- partner entitlement view reflects policy updates,
- admin-only signed audit export + pagination,
- export signature verification and tamper-fail behavior.

## Acceptance criteria
- `npm run verify:m57` exits 0.
- `node verify/runner.mjs milestones/M57.yaml` returns `overall=true`.
- artifacts exist under `artifacts/milestones/M57/latest/*`.
