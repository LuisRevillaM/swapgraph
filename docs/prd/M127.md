# M127 â€” Marketplace matching diff-helper decomposition (non-breaking, parity-gated)

## Objective
Further decompose `marketplaceMatchingService` by extracting diff/safety/shadow record construction helpers into dedicated modules with concrete TS parity, while keeping JS runtime behavior authoritative and unchanged.

## Scope
- Add extracted JS helper module:
  - `src/service/marketplaceMatchingDiffHelpers.mjs`
- Add concrete TS parity module:
  - `src-ts/service/marketplaceMatchingDiffHelpers.mts`
- Rewire service to import extracted diff-helper functions:
  - `src/service/marketplaceMatchingService.mjs`
- Add deterministic extraction + parity verifier:
  - `scripts/run-m127-typescript-service-diff-helper-parity-scenario.mjs`
  - `fixtures/release/m127_scenario.json`
  - `fixtures/release/m127_expected.json`
  - `verify/m127.sh`
  - `milestones/M127.yaml`

## Non-goals (M127)
- No API/schema changes.
- No runtime cutover to TS service execution.
- No matcher algorithm or policy changes.
- No changes to v2 routing, canary, rollback, or auth contracts.

## Acceptance criteria
- `npm run verify:m127` exits 0.
- `npm run verify:m126` exits 0 (composed dependency gate).
- `npm run verify:m125` exits 0 (runtime behavior dependency gate).
- Verifier proves:
  - TS diff-helper module is concrete (not wrapper-only).
  - JS/TS diff-helper export surfaces match expected function set.
  - normalized parity hash matches between JS and TS diff-helper modules.
  - extracted functions are imported into `marketplaceMatchingService` and no longer locally defined.

## Required artifacts
- `docs/prd/M127.md`
- `src/service/marketplaceMatchingDiffHelpers.mjs`
- `src-ts/service/marketplaceMatchingDiffHelpers.mts`
- `src/service/marketplaceMatchingService.mjs`
- `scripts/run-m127-typescript-service-diff-helper-parity-scenario.mjs`
- `fixtures/release/m127_scenario.json`
- `fixtures/release/m127_expected.json`
- `verify/m127.sh`
- `milestones/M127.yaml`
- `artifacts/milestones/M127/latest/typescript_service_diff_helper_parity_output.json`
- `artifacts/milestones/M127/latest/assertions.json`
- `artifacts/milestones/M127/latest/commands.log`
