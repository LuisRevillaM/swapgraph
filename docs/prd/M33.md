# M33 — Delegation lifecycle (expiry/revocation) + agent read access expansion

## Objective
Build on M32 delegation grants by adding **lifecycle controls** and expanding **agent read access** (still fixtures-first).

This milestone focuses on:
1) rejecting **revoked** and **expired** delegation grants (deterministically in verifiers)
2) allowing agents (with delegation) to **read** the same objects as their delegated user for:
   - Cycle proposals
   - Settlement status/instructions
   - Receipts

## Scope

### 1) Delegation lifecycle
Update delegation enforcement in `src/core/authz.mjs` (behind `AUTHZ_ENFORCE=1`):
- If `auth.delegation.revoked_at` is present ⇒ reject.
- If a deterministic `now` is provided (`auth.now_iso`) and `now > delegation.expires_at` ⇒ reject.

Notes:
- We intentionally use `auth.now_iso` in verifiers to avoid time-dependent tests.

### 2) Agent read access expansion
Update `docs/spec/api/manifest.v1.json` to include `agent` in `allowed_actor_types` for read endpoints:
- `cycleProposals.list` / `cycleProposals.get`
- `settlement.status` / `settlement.instructions`
- `receipts.get`

Update read services so that, when `AUTHZ_ENFORCE=1` and `actor.type=agent`:
- business logic runs as the **delegated subject user** (`auth.delegation.subject_actor`)
- access checks behave exactly like a user participant

When `AUTHZ_ENFORCE` is not enabled, keep legacy behavior (agent access remains `FORBIDDEN`) to avoid breaking older milestones.

### 3) Proof scenario
Add a deterministic verifier scenario proving:
- agent with valid delegation + scope can read cycle proposals + settlement status + receipts
- missing scope ⇒ `INSUFFICIENT_SCOPE`
- revoked delegation ⇒ `UNAUTHORIZED`
- expired delegation (via `auth.now_iso`) ⇒ `UNAUTHORIZED`

## Acceptance criteria
- `npm run verify:m33` exits 0.
- `node verify/runner.mjs milestones/M33.yaml` overall=true.
- Proof artifacts captured under `artifacts/milestones/M33/latest/*`.

## Required artifacts
- `docs/prd/M33.md`
- updated delegation contract + auth docs
- updated API manifest actor-types
- updated authz + read services
- `fixtures/delegation/m33_*` + `scripts/run-m33-delegation-lifecycle-scenario.mjs`
- `verify/m33.sh` + `milestones/M33.yaml`
