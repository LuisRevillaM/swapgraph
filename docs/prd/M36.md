# M36 â€” Delegation-token key publication/rotation + introspection (fixtures-first)

## Objective
Complete the trust loop around agent delegation tokens by adding:
1) a published key-set contract for delegation-token verification (with rotation metadata), and
2) a token introspection contract to evaluate token activity deterministically.

This milestone keeps the implementation fixtures-first and deterministic.

## Scope

### 1) Delegation-token signing key publication contract
Add a public key endpoint contract:
- `GET /keys/delegation-token-signing`

Response includes:
- `active_key_id`
- `keys[]` with `key_id`, `alg`, `public_key_pem`, and key `status` (`active` | `verify_only`)

Notes:
- v1 uses `ed25519`.
- keyset supports rotation: old keys stay published as `verify_only` for signature verification.

### 2) Key rotation behavior in token signing module
Extend `src/crypto/delegationTokenSigning.mjs` to:
- support multiple known signing keys (`dev-dt-k1`, `dev-dt-k2` fixtures)
- select active minting key via environment (`DELEGATION_TOKEN_SIGNING_ACTIVE_KEY_ID`, default `dev-dt-k1`)
- verify tokens by `signature.key_id` against the published key set

### 3) Delegation-token introspection contract
Add endpoint contract:
- `POST /auth/delegation-token/introspect`

Request:
- `delegation_token`
- optional `now_iso` for deterministic lifecycle evaluation

Response:
- `active` boolean
- stable `reason` enum (`active`, `expired`, `revoked`, `invalid_signature`, etc.)
- optional resolved `delegation`
- diagnostic `details`

Lifecycle checks:
- signature validity
- unknown key id / unsupported alg
- persisted revocation (`store.state.delegations`)
- deterministic expiry (`now_iso`)

### 4) Proof scenario
Add deterministic scenario proving:
- delegation-token keyset publication includes rotation metadata
- mint under key k1, then rotate active key to k2
- tokens signed pre-rotation remain verifiable
- tokens signed post-rotation verify with new active key
- tampered token fails introspection (`invalid_signature`)
- unknown key id fails introspection (`unknown_key_id`)
- revoked and expired delegations return inactive with stable reasons

## Acceptance criteria
- `npm run verify:m36` exits 0.
- `node verify/runner.mjs milestones/M36.yaml` overall=true.
- Proof artifacts under `artifacts/milestones/M36/latest/*`.
