# M29 â€” Webhook/event signing + replay protection (fixtures-first)

## Objective
Make SwapGraph **events** verifiable by consumers.

This closes a major integration trust gap:
- partners consume events via **webhooks / streams / replay**
- consumers must be able to verify events were produced by SwapGraph (not forged)
- consumers must be able to safely handle **replays** (at-least-once delivery)

In production, this is typically implemented with a signed payload + timestamp header.
Because we are still **fixtures-first** (no HTTP server yet), we model event signing directly on the `EventEnvelope` contract.

## Scope
### 1) EventEnvelope signature contract
Update `EventEnvelope.schema.json` to require a signature:
- `signature.key_id`
- `signature.alg` (v1: `"ed25519"`)
- `signature.sig` (base64)

Signing message (deterministic):
- `canonical_json(EventEnvelope without signature)`

### 2) Event signing keys (API-first)
Add an explicit key publication endpoint for event signatures:
- `GET /keys/event-signing` (`keys.event_signing.get`)

Provide:
- schemas: `EventSigningKey`, `EventSigningKeysGetResponse`
- example response under `docs/spec/examples/api/`
- doc updates in `docs/spec/KEYS.md` and `docs/spec/EVENTS.md`

### 3) Implementation (fixtures-first)
- Add a non-production dev keypair under `fixtures/keys/`.
- Add a signing/verification utility: `src/crypto/eventSigning.mjs`.
- Ensure all event emitters include `EventEnvelope.signature`:
  - delivery events (`proposal.created`, `proposal.expiring`)
  - commit events (`intent.reserved`, `intent.unreserved`, `cycle.state_changed`)
  - settlement events (`settlement.*`, `receipt.created`, plus cycle state)

### 4) Fixture updates
Update static fixtures containing event envelopes to include valid signatures:
- `fixtures/delivery/m6_expected.json` (webhook events)
- `fixtures/events/event_log.v1.ndjson`
- `fixtures/events/event_log.v2.ndjson`
- `docs/spec/examples/EventEnvelope.example.json`

### 5) Verification (proof-gated)
Add a verifier that:
- validates schemas + manifests + API examples
- generates signed events via scenarios
- verifies signatures for every event envelope found in:
  - static event logs (v1/v2)
  - webhook delivery fixture (M6)
  - generated outbox NDJSON from commit + settlement scenarios
- proves a **tampered** event fails verification

## Replay protection (v1)
- Delivery is **at-least-once**.
- Consumers MUST de-duplicate by `event_id`.
- Signatures prevent forged/tampered events; dedupe prevents replay side-effects.

## Acceptance criteria
- `npm run verify:m29` exits 0.
- `node verify/runner.mjs milestones/M29.yaml` exits 0.

## Required artifacts
- `docs/prd/M29.md`
- updated event envelope schema + example
- key publication contract (schemas + example) + docs updates
- signed fixtures + signature verifier proof under `artifacts/milestones/M29/latest/*`
