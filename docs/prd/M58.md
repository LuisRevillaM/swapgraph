# M58 â€” Rollout-policy audit export continuity + checkpoint retention hardening (fixtures-first)

## Objective
Harden `partnerProgram.vault_export.rollout_policy_audit.export` with deterministic continuation integrity and checkpoint-retention controls, mirroring established signed export-chain contracts.

## Scope

### 1) Signed export continuity primitives
Extend rollout-policy audit export payload to support deterministic pagination continuity:
- signed `attestation` chain (page hash + chain hash)
- optional signed `checkpoint` anchors (checkpoint hash)

Continuation parameters:
- `cursor_after`
- `attestation_after`
- `checkpoint_after` (when checkpoint mode is enforced)

### 2) Stateful checkpoint continuation validation
When checkpoint enforcement is enabled (`PARTNER_PROGRAM_ROLLOUT_POLICY_EXPORT_CHECKPOINT_ENFORCE=1`):
- continuation requires `checkpoint_after` alongside `cursor_after`
- validate checkpoint existence, cursor lock, attestation-chain lock, and query-context lock.

Deterministic reason codes:
- `checkpoint_after_not_found`
- `checkpoint_cursor_mismatch`
- `checkpoint_attestation_mismatch`
- `checkpoint_query_mismatch`

### 3) Checkpoint retention + expiry
Add retention controls for rollout-policy export checkpoints:
- env: `PARTNER_PROGRAM_ROLLOUT_POLICY_EXPORT_CHECKPOINT_RETENTION_DAYS`
- deterministic expiry failure reason code: `checkpoint_expired`
- opportunistic pruning of expired checkpoint anchors.

### 4) Contract + state updates
- update rollout-policy audit export response schema with `attestation` + `checkpoint` envelopes
- add store state for rollout-policy export checkpoints
- extend crypto signing/verifier helpers for rollout-policy export attestation/checkpoint structures.

### 5) Fixtures-first verifier
Scenario proves:
- successful page-1 and page-2 continuation with attestation/checkpoint chaining,
- missing checkpoint rejection under enforced mode,
- deterministic failures for not-found/cursor/attestation/query mismatches,
- deterministic expiry rejection after retention window,
- signed payload verification + tamper-fail checks.

## Acceptance criteria
- `npm run verify:m58` exits 0.
- `node verify/runner.ts milestones/M58.yaml` returns `overall=true`.
- artifacts exist under `artifacts/milestones/M58/latest/*`.
