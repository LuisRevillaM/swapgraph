# M38 â€” Advanced delegated write-path policy controls (`max_value_per_day_usd`, consent hooks, audit trail)

## Objective
Harden delegated agent write behavior on `swapIntents.*` by adding:
1) deterministic daily spend enforcement,
2) high-value consent hook scaffolding, and
3) explicit policy audit records for delegated write decisions.

This milestone is fixtures-first and does not introduce production transport concerns.

## Scope

### 1) Daily spend cap enforcement
For delegated agent writes (`swapIntents.create/update`), enforce:
- `TradingPolicy.max_value_per_day_usd`

Rules:
- spend is tracked by delegated **subject user** in UTC day buckets
- projected daily spend includes update deltas (`next - previous`)
- violation returns deterministic policy error

### 2) High-value consent hook
Support optional policy hook:
- `TradingPolicy.high_value_consent_threshold_usd`

When intent `value_band.max_usd` exceeds threshold:
- require `auth.user_consent` payload in fixtures-first calls
- validate basic consent fields (`consent_id`, optional cap/expiry)
- fail deterministically when consent is missing/insufficient/expired

### 3) Delegated write audit trail
Record audit entries for delegated write-path decisions:
- operation id (`swapIntents.create|update|cancel`)
- actor + delegated subject
- decision (`allow`/`deny`)
- reason code
- policy snapshot + deterministic details

Store-backed fixtures-first fields:
- `state.policy_spend_daily`
- `state.policy_audit`

### 4) Shared policy helper expansion
Extend policy helper module with reusable evaluators for:
- intent policy checks
- daily cap projection
- high-value consent evaluation
- time/day normalization

### 5) Proof scenario
Add deterministic scenario proving:
- allowed delegated write under cap
- high-value write denied without consent and allowed with consent
- daily cap denial and subsequent allowance after update/cancel adjustments
- audit records include allow/deny decisions and reason codes

## Acceptance criteria
- `npm run verify:m38` exits 0.
- `node verify/runner.ts milestones/M38.yaml` overall=true.
- proof artifacts exist under `artifacts/milestones/M38/latest/*`.
