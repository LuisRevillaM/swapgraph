# M32 — Agent delegation tokens + TradingPolicy enforcement (SwapIntents)

## Objective
Make `actor.type = agent` usable in v1 fixtures via **delegation grants**.

Agents are *delegated automation* that may act on behalf of a user **only** when:
- a valid `DelegationGrant` is present
- required endpoint scopes are satisfied
- the action conforms to an explicit `TradingPolicy`

This milestone is fixtures-first and proof-gated.

## Scope
### 1) Delegation grant contract
Add a stable delegation object:
- `docs/spec/schemas/DelegationGrant.schema.json`
- `docs/spec/examples/DelegationGrant.example.json`

A `DelegationGrant` binds:
- `principal_agent` (the agent actor)
- `subject_actor` (the user the agent may act for)
- `scopes` (granted scopes)
- `policy` (`TradingPolicy`)
- `issued_at` / `expires_at`

### 2) Auth modeling
Update `docs/spec/AUTH.md` to define how delegation is represented in fixtures-first verification:
- `auth.delegation` (a `DelegationGrant`)
- scopes may be provided via `auth.scopes` or `auth.delegation.scopes`

### 3) API manifest actor-types
Allow `actor.type=agent` for `swapIntents.*` endpoints in:
- `docs/spec/api/manifest.v1.json`

(Other endpoints remain forbidden for agents until later milestones.)

### 4) Enforcement (fixtures-first)
Build on M31 `AUTHZ_ENFORCE=1` enforcement:
- `src/core/authz.mjs` now requires `auth.delegation` for agent actors
  - principal must match the agent
  - subject must be a user

Enforce subject + policy in `SwapIntentsService`:
- agent may only create/update/cancel/get/list intents where `intent.actor == delegation.subject_actor`
- enforce `TradingPolicy` constraints on create/update:
  - `intent.value_band.max_usd <= policy.max_value_per_swap_usd`
  - `intent.trust_constraints.max_cycle_length <= policy.max_cycle_length` (if provided)
  - `intent.settlement_preferences.require_escrow == policy.require_escrow` (if provided)

### 5) Proof scenario
Add `scripts/run-m32-delegation-scenario.mjs` proving:
- agent without delegation ⇒ `FORBIDDEN`
- agent with delegation but missing scope ⇒ `INSUFFICIENT_SCOPE`
- agent with scope but subject mismatch ⇒ `FORBIDDEN`
- agent policy violation ⇒ `FORBIDDEN`
- happy path create + list + get works for the delegated subject

## Acceptance criteria
- `npm run verify:m32` exits 0.
- `node verify/runner.mjs milestones/M32.yaml` overall=true.
- Proof artifacts exist under `artifacts/milestones/M32/latest/*`.

## Non-goals
- Delegation token minting/rotation/revocation APIs (later milestone).
- Agent access to proposals/commit/settlement.
- Policy enforcement across matching/commit/settlement.
