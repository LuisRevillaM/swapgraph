#!/usr/bin/env node
import { mkdirSync, readFileSync, writeFileSync } from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(__dirname, '../..');
const sourcePath = path.join(repoRoot, 'client/marketplace/tokens/design-tokens.json');
const cssOutPath = path.join(repoRoot, 'client/marketplace/generated/tokens.css');
const themeOutPath = path.join(repoRoot, 'client/marketplace/generated/theme.mjs');

function readJson(filePath) {
  return JSON.parse(readFileSync(filePath, 'utf8'));
}

function parseReadabilityFloorPx(value) {
  if (typeof value !== 'string') return null;
  const match = value.match(/([0-9]+(?:\.[0-9]+)?)px/);
  if (!match) return null;
  return Number.parseFloat(match[1]);
}

function buildCss(tokens) {
  const lines = [];
  const floorPx = parseReadabilityFloorPx(tokens?.typography?.['readability-floor']);

  lines.push('/* Auto-generated by scripts/web-m1/build-marketplace-token-artifacts.mjs */');
  lines.push(':root {');

  for (const [name, value] of Object.entries(tokens.color ?? {})) {
    lines.push(`  --${name}: ${String(value)};`);
  }

  for (const [name, value] of Object.entries(tokens.typography?.families ?? {})) {
    lines.push(`  --font-${name}: "${String(value)}";`);
  }

  for (const [name, value] of Object.entries(tokens.typography?.scale ?? {})) {
    if (typeof value?.rem === 'number') lines.push(`  --t-${name}: ${value.rem}rem;`);
    if (typeof value?.px === 'number') lines.push(`  --t-${name}-px: ${value.px}px;`);
  }

  if (typeof floorPx === 'number' && Number.isFinite(floorPx)) {
    lines.push(`  --readability-floor-px: ${floorPx};`);
    lines.push('  --readability-floor-rem: var(--t-sm);');
  }

  for (const [name, value] of Object.entries(tokens.spacing ?? {})) {
    lines.push(`  --${name}: ${String(value)};`);
  }

  for (const [name, value] of Object.entries(tokens.shadow ?? {})) {
    lines.push(`  --shadow-${name}: ${String(value)};`);
  }

  lines.push('}');
  lines.push('');
  return lines.join('\n');
}

function buildThemeModule(tokens) {
  const serialized = JSON.stringify(tokens, null, 2);
  return [
    '// Auto-generated by scripts/web-m1/build-marketplace-token-artifacts.mjs',
    'export const marketplaceThemeTokens = ' + serialized + ';',
    '',
    'export function getThemeToken(path, fallback = null) {',
    '  if (!Array.isArray(path) || path.length === 0) return fallback;',
    '  let cursor = marketplaceThemeTokens;',
    '  for (const segment of path) {',
    '    if (!cursor || typeof cursor !== "object" || !(segment in cursor)) return fallback;',
    '    cursor = cursor[segment];',
    '  }',
    '  return cursor;',
    '}'
  ].join('\n');
}

function main() {
  const tokens = readJson(sourcePath);
  mkdirSync(path.dirname(cssOutPath), { recursive: true });
  mkdirSync(path.dirname(themeOutPath), { recursive: true });

  writeFileSync(cssOutPath, buildCss(tokens), 'utf8');
  writeFileSync(themeOutPath, buildThemeModule(tokens), 'utf8');

  const summary = {
    source: path.relative(repoRoot, sourcePath),
    outputs: [
      path.relative(repoRoot, cssOutPath),
      path.relative(repoRoot, themeOutPath)
    ]
  };
  process.stdout.write(JSON.stringify(summary, null, 2) + '\n');
}

main();
