{
  "actors": {
    "user_u1": { "type": "user", "id": "u1" },
    "user_u2": { "type": "user", "id": "u2" },
    "agent_1": { "type": "agent", "id": "agent_1" }
  },
  "operations": [
    {
      "op": "delegations.create",
      "actor_ref": "user_u1",
      "idempotency_key": "idem_m41_d1",
      "occurred_at": "2026-02-18T12:00:00Z",
      "auth": { "scopes": ["delegations:write"] },
      "request": {
        "delegation": {
          "delegation_id": "del_m41_u1_agent1",
          "principal_agent": { "type": "agent", "id": "agent_1" },
          "scopes": ["swap_intents:write", "swap_intents:read", "delegations:read"],
          "policy": {
            "max_value_per_swap_usd": 500,
            "max_value_per_day_usd": 1200,
            "high_value_consent_threshold_usd": 100,
            "min_confidence_score": 0.7,
            "max_cycle_length": 3,
            "require_escrow": true
          },
          "expires_at": "2026-02-20T12:00:00Z"
        }
      },
      "save_token_ref": "token_u1_agent1",
      "expect_ok": true
    },
    {
      "op": "keys.policy_integrity_signing.get",
      "expect_ok": true,
      "expect_active_key_id": "dev-pi-k1",
      "expect_keys_count": 2,
      "expect_key_statuses": {
        "dev-pi-k1": "active",
        "dev-pi-k2": "verify_only"
      }
    },
    {
      "op": "authHeaders.parse",
      "token_ref": "token_u1_agent1",
      "expect_ok": true,
      "expect_actor": { "type": "agent", "id": "agent_1" }
    },
    {
      "op": "swapIntents.create.via_token",
      "token_ref": "token_u1_agent1",
      "idempotency_key": "idem_m41_i0",
      "auth": {
        "now_iso": "2026-02-18T12:10:00Z"
      },
      "request": {
        "intent": {
          "id": "intent_m41_i0",
          "actor": { "type": "user", "id": "u1" },
          "offer": [{ "platform": "steam", "asset_id": "asset_m41_i0" }],
          "want_spec": { "type": "set", "any_of": [{ "type": "specific_asset", "platform": "steam", "asset_key": "steam:730:item:m41_i0" }] },
          "value_band": { "min_usd": 110, "max_usd": 140, "pricing_source": "market_median" },
          "trust_constraints": { "max_cycle_length": 3, "min_counterparty_reliability": 4 },
          "time_constraints": { "expires_at": "2026-03-01T00:00:00Z", "urgency": "normal" },
          "settlement_preferences": { "require_escrow": true }
        }
      },
      "expect_ok": false,
      "expect_error_code": "FORBIDDEN",
      "expect_reason_code": "consent_required"
    },
    {
      "op": "swapIntents.create.via_token",
      "token_ref": "token_u1_agent1",
      "idempotency_key": "idem_m41_i1_plain",
      "auth": {
        "now_iso": "2026-02-18T12:10:00Z",
        "user_consent": {
          "consent_id": "consent_m41_i1",
          "consent_tier": "step_up",
          "consent_proof_mode": "plain_bound",
          "approved_max_usd": 200,
          "expires_at": "2026-02-18T13:00:00Z"
        }
      },
      "request": {
        "intent": {
          "id": "intent_m41_i1",
          "actor": { "type": "user", "id": "u1" },
          "offer": [{ "platform": "steam", "asset_id": "asset_m41_i1" }],
          "want_spec": { "type": "set", "any_of": [{ "type": "specific_asset", "platform": "steam", "asset_key": "steam:730:item:m41_i1" }] },
          "value_band": { "min_usd": 120, "max_usd": 130, "pricing_source": "market_median" },
          "trust_constraints": { "max_cycle_length": 3, "min_counterparty_reliability": 4 },
          "time_constraints": { "expires_at": "2026-03-01T00:00:00Z", "urgency": "normal" },
          "settlement_preferences": { "require_escrow": true }
        }
      },
      "expect_ok": false,
      "expect_error_code": "FORBIDDEN",
      "expect_reason_code": "consent_proof_signature_required"
    },
    {
      "op": "swapIntents.create.via_token",
      "token_ref": "token_u1_agent1",
      "idempotency_key": "idem_m41_i1_mismatch",
      "auth": {
        "now_iso": "2026-02-18T12:10:00Z",
        "user_consent": {
          "consent_id": "consent_m41_i1",
          "consent_tier": "step_up",
          "consent_proof_mode": "signed_mismatch",
          "consent_proof_issued_at": "2026-02-18T12:09:00Z",
          "consent_proof_expires_at": "2026-02-18T12:30:00Z",
          "approved_max_usd": 200,
          "expires_at": "2026-02-18T13:00:00Z"
        }
      },
      "request": {
        "intent": {
          "id": "intent_m41_i1",
          "actor": { "type": "user", "id": "u1" },
          "offer": [{ "platform": "steam", "asset_id": "asset_m41_i1" }],
          "want_spec": { "type": "set", "any_of": [{ "type": "specific_asset", "platform": "steam", "asset_key": "steam:730:item:m41_i1" }] },
          "value_band": { "min_usd": 120, "max_usd": 130, "pricing_source": "market_median" },
          "trust_constraints": { "max_cycle_length": 3, "min_counterparty_reliability": 4 },
          "time_constraints": { "expires_at": "2026-03-01T00:00:00Z", "urgency": "normal" },
          "settlement_preferences": { "require_escrow": true }
        }
      },
      "expect_ok": false,
      "expect_error_code": "FORBIDDEN",
      "expect_reason_code": "consent_proof_mismatch"
    },
    {
      "op": "swapIntents.create.via_token",
      "token_ref": "token_u1_agent1",
      "idempotency_key": "idem_m41_i1_bad_sig",
      "auth": {
        "now_iso": "2026-02-18T12:10:00Z",
        "user_consent": {
          "consent_id": "consent_m41_i1",
          "consent_tier": "step_up",
          "consent_proof_mode": "signed_bad_signature",
          "consent_proof_issued_at": "2026-02-18T12:09:00Z",
          "consent_proof_expires_at": "2026-02-18T12:30:00Z",
          "approved_max_usd": 200,
          "expires_at": "2026-02-18T13:00:00Z"
        }
      },
      "request": {
        "intent": {
          "id": "intent_m41_i1",
          "actor": { "type": "user", "id": "u1" },
          "offer": [{ "platform": "steam", "asset_id": "asset_m41_i1" }],
          "want_spec": { "type": "set", "any_of": [{ "type": "specific_asset", "platform": "steam", "asset_key": "steam:730:item:m41_i1" }] },
          "value_band": { "min_usd": 120, "max_usd": 130, "pricing_source": "market_median" },
          "trust_constraints": { "max_cycle_length": 3, "min_counterparty_reliability": 4 },
          "time_constraints": { "expires_at": "2026-03-01T00:00:00Z", "urgency": "normal" },
          "settlement_preferences": { "require_escrow": true }
        }
      },
      "expect_ok": false,
      "expect_error_code": "FORBIDDEN",
      "expect_reason_code": "consent_proof_signature_invalid"
    },
    {
      "op": "swapIntents.create.via_token",
      "token_ref": "token_u1_agent1",
      "idempotency_key": "idem_m41_i1_expired",
      "auth": {
        "now_iso": "2026-02-18T12:10:00Z",
        "user_consent": {
          "consent_id": "consent_m41_i1",
          "consent_tier": "step_up",
          "consent_proof_mode": "signed_expired",
          "consent_proof_issued_at": "2026-02-18T12:01:00Z",
          "consent_proof_expires_at": "2026-02-18T12:05:00Z",
          "approved_max_usd": 200,
          "expires_at": "2026-02-18T13:00:00Z"
        }
      },
      "request": {
        "intent": {
          "id": "intent_m41_i1",
          "actor": { "type": "user", "id": "u1" },
          "offer": [{ "platform": "steam", "asset_id": "asset_m41_i1" }],
          "want_spec": { "type": "set", "any_of": [{ "type": "specific_asset", "platform": "steam", "asset_key": "steam:730:item:m41_i1" }] },
          "value_band": { "min_usd": 120, "max_usd": 130, "pricing_source": "market_median" },
          "trust_constraints": { "max_cycle_length": 3, "min_counterparty_reliability": 4 },
          "time_constraints": { "expires_at": "2026-03-01T00:00:00Z", "urgency": "normal" },
          "settlement_preferences": { "require_escrow": true }
        }
      },
      "expect_ok": false,
      "expect_error_code": "FORBIDDEN",
      "expect_reason_code": "consent_proof_expired"
    },
    {
      "op": "swapIntents.create.via_token",
      "token_ref": "token_u1_agent1",
      "idempotency_key": "idem_m41_i1_ok",
      "auth": {
        "now_iso": "2026-02-18T12:10:00Z",
        "user_consent": {
          "consent_id": "consent_m41_i1",
          "consent_tier": "step_up",
          "consent_proof_mode": "signed_bound",
          "consent_proof_issued_at": "2026-02-18T12:09:00Z",
          "consent_proof_expires_at": "2026-02-18T12:30:00Z",
          "approved_max_usd": 200,
          "expires_at": "2026-02-18T13:00:00Z"
        }
      },
      "request": {
        "intent": {
          "id": "intent_m41_i1",
          "actor": { "type": "user", "id": "u1" },
          "offer": [{ "platform": "steam", "asset_id": "asset_m41_i1" }],
          "want_spec": { "type": "set", "any_of": [{ "type": "specific_asset", "platform": "steam", "asset_key": "steam:730:item:m41_i1" }] },
          "value_band": { "min_usd": 120, "max_usd": 130, "pricing_source": "market_median" },
          "trust_constraints": { "max_cycle_length": 3, "min_counterparty_reliability": 4 },
          "time_constraints": { "expires_at": "2026-03-01T00:00:00Z", "urgency": "normal" },
          "settlement_preferences": { "require_escrow": true }
        }
      },
      "expect_ok": true
    },
    {
      "op": "swapIntents.create.via_token",
      "token_ref": "token_u1_agent1",
      "idempotency_key": "idem_m41_i2_tier",
      "auth": {
        "now_iso": "2026-02-18T12:10:00Z",
        "user_consent": {
          "consent_id": "consent_m41_i2",
          "consent_tier": "step_up",
          "consent_proof_mode": "signed_bound",
          "consent_proof_issued_at": "2026-02-18T12:09:30Z",
          "consent_proof_expires_at": "2026-02-18T12:30:00Z",
          "approved_max_usd": 220,
          "expires_at": "2026-02-18T13:00:00Z"
        }
      },
      "request": {
        "intent": {
          "id": "intent_m41_i2",
          "actor": { "type": "user", "id": "u1" },
          "offer": [{ "platform": "steam", "asset_id": "asset_m41_i2" }],
          "want_spec": { "type": "set", "any_of": [{ "type": "specific_asset", "platform": "steam", "asset_key": "steam:730:item:m41_i2" }] },
          "value_band": { "min_usd": 170, "max_usd": 180, "pricing_source": "market_median" },
          "trust_constraints": { "max_cycle_length": 3, "min_counterparty_reliability": 4 },
          "time_constraints": { "expires_at": "2026-03-01T00:00:00Z", "urgency": "normal" },
          "settlement_preferences": { "require_escrow": true }
        }
      },
      "expect_ok": false,
      "expect_error_code": "FORBIDDEN",
      "expect_reason_code": "consent_tier_insufficient"
    },
    {
      "op": "swapIntents.create.via_token",
      "token_ref": "token_u1_agent1",
      "idempotency_key": "idem_m41_i2_ok",
      "auth": {
        "now_iso": "2026-02-18T12:10:00Z",
        "user_consent": {
          "consent_id": "consent_m41_i2",
          "consent_tier": "passkey",
          "consent_proof_mode": "signed_bound",
          "consent_proof_issued_at": "2026-02-18T12:09:45Z",
          "consent_proof_expires_at": "2026-02-18T12:30:00Z",
          "approved_max_usd": 220,
          "expires_at": "2026-02-18T13:00:00Z"
        }
      },
      "request": {
        "intent": {
          "id": "intent_m41_i2",
          "actor": { "type": "user", "id": "u1" },
          "offer": [{ "platform": "steam", "asset_id": "asset_m41_i2" }],
          "want_spec": { "type": "set", "any_of": [{ "type": "specific_asset", "platform": "steam", "asset_key": "steam:730:item:m41_i2" }] },
          "value_band": { "min_usd": 170, "max_usd": 180, "pricing_source": "market_median" },
          "trust_constraints": { "max_cycle_length": 3, "min_counterparty_reliability": 4 },
          "time_constraints": { "expires_at": "2026-03-01T00:00:00Z", "urgency": "normal" },
          "settlement_preferences": { "require_escrow": true }
        }
      },
      "expect_ok": true
    },
    {
      "op": "policyAudit.list",
      "actor_ref": "user_u1",
      "auth": { "scopes": ["delegations:read"] },
      "query": {
        "subject_actor_id": "u1",
        "limit": 3,
        "now_iso": "2026-02-18T12:20:00Z"
      },
      "expect_ok": true,
      "expect_entries_count": 3,
      "expect_next_cursor": "pa_3",
      "expect_total_filtered": 8,
      "expect_reason_codes": [
        "consent_required",
        "consent_proof_signature_required",
        "consent_proof_mismatch"
      ]
    },
    {
      "op": "policyAudit.export",
      "actor_ref": "user_u1",
      "auth": { "scopes": ["delegations:read"] },
      "query": {
        "subject_actor_id": "u1",
        "decision": "deny",
        "now_iso": "2026-02-18T12:20:00Z",
        "exported_at_iso": "2026-02-18T12:20:00Z"
      },
      "save_export_ref": "export_u1_deny",
      "expect_ok": true,
      "expect_entries_count": 6,
      "expect_total_filtered": 6,
      "expect_verify_ok": true,
      "expect_verify_public_ok": true,
      "expect_reason_codes": [
        "consent_required",
        "consent_proof_signature_required",
        "consent_proof_mismatch",
        "consent_proof_signature_invalid",
        "consent_proof_expired",
        "consent_tier_insufficient"
      ]
    },
    {
      "op": "policyAudit.export",
      "actor_ref": "user_u1",
      "auth": { "scopes": ["delegations:read"] },
      "query": {
        "subject_actor_id": "u1",
        "decision": "allow",
        "now_iso": "2026-02-18T12:20:00Z",
        "exported_at_iso": "2026-02-18T12:20:00Z"
      },
      "save_export_ref": "export_u1_allow",
      "expect_ok": true,
      "expect_entries_count": 2,
      "expect_total_filtered": 2,
      "expect_verify_ok": true,
      "expect_verify_public_ok": true,
      "expect_reason_codes": [
        "ok",
        "ok"
      ]
    },
    {
      "op": "policyAudit.export.verify_tampered",
      "export_ref": "export_u1_deny",
      "expect_verify_ok": false,
      "expect_verify_error": "hash_mismatch"
    },
    {
      "op": "policyAudit.export.via_token",
      "token_ref": "token_u1_agent1",
      "auth": {
        "now_iso": "2026-02-18T12:20:00Z"
      },
      "query": {
        "subject_actor_id": "u1",
        "decision": "deny",
        "now_iso": "2026-02-18T12:20:00Z",
        "exported_at_iso": "2026-02-18T12:20:00Z"
      },
      "expect_ok": false,
      "expect_error_code": "FORBIDDEN"
    },
    {
      "op": "policyAudit.export",
      "actor_ref": "user_u2",
      "auth": { "scopes": ["delegations:read"] },
      "query": {
        "subject_actor_id": "u2",
        "now_iso": "2026-02-18T12:20:00Z",
        "exported_at_iso": "2026-02-18T12:20:00Z"
      },
      "save_export_ref": "export_u2_all",
      "expect_ok": true,
      "expect_entries_count": 0,
      "expect_total_filtered": 0,
      "expect_verify_ok": true,
      "expect_verify_public_ok": true,
      "expect_reason_codes": []
    }
  ]
}
