{
  "actors": {
    "partner": { "type": "partner", "id": "swapgraph" },
    "user_u1": { "type": "user", "id": "u1" },
    "user_u2": { "type": "user", "id": "u2" },
    "user_u3": { "type": "user", "id": "u3" }
  },
  "operations": [
    { "op": "keys.policy_integrity_signing.get", "expect_ok": true, "expect_keys_count": 2 },

    { "op": "cycleProposals.accept", "proposal_ref": "p3", "actor_ref": "user_u1", "occurred_at": "2026-02-19T03:40:10Z", "idempotency_key": "m55_p3_u1", "auth": { "scopes": ["commits:write"] } },
    { "op": "cycleProposals.accept", "proposal_ref": "p3", "actor_ref": "user_u2", "occurred_at": "2026-02-19T03:40:11Z", "idempotency_key": "m55_p3_u2", "auth": { "scopes": ["commits:write"] } },
    { "op": "cycleProposals.accept", "proposal_ref": "p3", "actor_ref": "user_u3", "occurred_at": "2026-02-19T03:40:12Z", "idempotency_key": "m55_p3_u3", "auth": { "scopes": ["commits:write"] } },

    {
      "op": "vault.deposit",
      "actor_ref": "user_u1",
      "idempotency_key": "m55_dep_hold_a",
      "now_iso": "2026-02-19T03:41:00Z",
      "auth": { "scopes": ["vault:write"] },
      "request": {
        "holding": {
          "holding_id": "hold_a",
          "vault_id": "vault_u1",
          "asset": { "platform": "steam", "asset_id": "assetA" },
          "owner_actor": { "type": "user", "id": "u1" },
          "deposit_id": "dep_a",
          "deposited_at": "2026-02-19T03:41:00Z"
        }
      }
    },
    {
      "op": "vault.deposit",
      "actor_ref": "user_u2",
      "idempotency_key": "m55_dep_hold_b",
      "now_iso": "2026-02-19T03:41:10Z",
      "auth": { "scopes": ["vault:write"] },
      "request": {
        "holding": {
          "holding_id": "hold_b",
          "vault_id": "vault_u2",
          "asset": { "platform": "steam", "asset_id": "assetB" },
          "owner_actor": { "type": "user", "id": "u2" },
          "deposit_id": "dep_b",
          "deposited_at": "2026-02-19T03:41:10Z"
        }
      }
    },
    {
      "op": "vault.deposit",
      "actor_ref": "user_u3",
      "idempotency_key": "m55_dep_hold_c",
      "now_iso": "2026-02-19T03:41:20Z",
      "auth": { "scopes": ["vault:write"] },
      "request": {
        "holding": {
          "holding_id": "hold_c",
          "vault_id": "vault_u3",
          "asset": { "platform": "steam", "asset_id": "assetC" },
          "owner_actor": { "type": "user", "id": "u3" },
          "deposit_id": "dep_c",
          "deposited_at": "2026-02-19T03:41:20Z"
        }
      }
    },

    { "op": "vault.reserve", "actor_ref": "partner", "idempotency_key": "m55_res_hold_a", "now_iso": "2026-02-19T03:41:30Z", "auth": { "scopes": ["vault:write"] }, "request": { "holding_id": "hold_a", "reservation_id": "rsv_hold_a" } },
    { "op": "vault.reserve", "actor_ref": "partner", "idempotency_key": "m55_res_hold_b", "now_iso": "2026-02-19T03:41:31Z", "auth": { "scopes": ["vault:write"] }, "request": { "holding_id": "hold_b", "reservation_id": "rsv_hold_b" } },
    { "op": "vault.reserve", "actor_ref": "partner", "idempotency_key": "m55_res_hold_c", "now_iso": "2026-02-19T03:41:32Z", "auth": { "scopes": ["vault:write"] }, "request": { "holding_id": "hold_c", "reservation_id": "rsv_hold_c" } },

    {
      "op": "settlement.start",
      "proposal_ref": "p3",
      "actor_ref": "partner",
      "occurred_at": "2026-02-19T03:42:00Z",
      "auth": { "scopes": ["settlement:write"] },
      "request_body": {
        "deposit_deadline_at": "2026-02-19T04:00:00Z",
        "vault_bindings": [
          { "intent_id": "intent_a", "holding_id": "hold_a", "reservation_id": "rsv_hold_a" },
          { "intent_id": "intent_b", "holding_id": "hold_b", "reservation_id": "rsv_hold_b" },
          { "intent_id": "intent_c", "holding_id": "hold_c", "reservation_id": "rsv_hold_c" }
        ]
      }
    },
    { "op": "settlement.begin_execution", "proposal_ref": "p3", "actor_ref": "partner", "occurred_at": "2026-02-19T03:42:20Z", "auth": { "scopes": ["settlement:write"] }, "request_body": {} },
    { "op": "settlement.complete", "proposal_ref": "p3", "actor_ref": "partner", "occurred_at": "2026-02-19T03:42:40Z", "auth": { "scopes": ["settlement:write"] }, "request_body": {} },

    {
      "op": "partner_program.configure",
      "partner_id": "swapgraph",
      "plan_id": "starter",
      "feature_enabled": true,
      "daily_limit": 2,
      "reset_usage": true
    },

    {
      "op": "settlement.vault_reconciliation.export",
      "proposal_ref": "p3",
      "actor_ref": "partner",
      "auth": { "scopes": ["settlement:read"] },
      "query": {
        "include_transitions": true,
        "now_iso": "2026-02-19T03:43:00Z",
        "exported_at_iso": "2026-02-19T03:43:00Z"
      },
      "save_export_ref": "export_starter_1",
      "expect_ok": true,
      "expect_timeline_state": "completed",
      "expect_reconciliation_mode": "full",
      "expect_entries_count": 3,
      "expect_reserved": 0,
      "expect_withdrawn": 3,
      "expect_program_plan_id": "starter",
      "expect_program_daily_limit": 2,
      "expect_program_daily_used": 1,
      "expect_transitions_count": 5
    },
    {
      "op": "settlement.vault_reconciliation.export",
      "proposal_ref": "p3",
      "actor_ref": "partner",
      "auth": { "scopes": ["settlement:read"] },
      "query": {
        "include_transitions": true,
        "now_iso": "2026-02-19T03:43:10Z",
        "exported_at_iso": "2026-02-19T03:43:10Z"
      },
      "save_export_ref": "export_starter_2",
      "expect_ok": true,
      "expect_timeline_state": "completed",
      "expect_reconciliation_mode": "full",
      "expect_entries_count": 3,
      "expect_reserved": 0,
      "expect_withdrawn": 3,
      "expect_program_plan_id": "starter",
      "expect_program_daily_limit": 2,
      "expect_program_daily_used": 2,
      "expect_transitions_count": 5
    },
    {
      "op": "settlement.vault_reconciliation.export",
      "proposal_ref": "p3",
      "actor_ref": "partner",
      "auth": { "scopes": ["settlement:read"] },
      "query": {
        "include_transitions": true,
        "now_iso": "2026-02-19T03:43:20Z",
        "exported_at_iso": "2026-02-19T03:43:20Z"
      },
      "expect_ok": false,
      "expect_error_code": "CONSTRAINT_VIOLATION",
      "expect_reason_code": "partner_quota_exceeded"
    },

    {
      "op": "partner_program.configure",
      "partner_id": "swapgraph",
      "plan_id": "starter",
      "feature_enabled": false,
      "daily_limit": 10,
      "reset_usage": false
    },
    {
      "op": "settlement.vault_reconciliation.export",
      "proposal_ref": "p3",
      "actor_ref": "partner",
      "auth": { "scopes": ["settlement:read"] },
      "query": {
        "include_transitions": true,
        "now_iso": "2026-02-19T03:43:30Z",
        "exported_at_iso": "2026-02-19T03:43:30Z"
      },
      "expect_ok": false,
      "expect_error_code": "FORBIDDEN",
      "expect_reason_code": "partner_feature_not_enabled"
    },

    {
      "op": "partner_program.configure",
      "partner_id": "swapgraph",
      "plan_id": "pro",
      "feature_enabled": true,
      "daily_limit": null,
      "reset_usage": true
    },
    {
      "op": "settlement.vault_reconciliation.export",
      "proposal_ref": "p3",
      "actor_ref": "partner",
      "auth": { "scopes": ["settlement:read"] },
      "query": {
        "include_transitions": true,
        "now_iso": "2026-02-19T03:43:40Z",
        "exported_at_iso": "2026-02-19T03:43:40Z"
      },
      "save_export_ref": "export_pro_1",
      "expect_ok": true,
      "expect_timeline_state": "completed",
      "expect_reconciliation_mode": "full",
      "expect_entries_count": 3,
      "expect_reserved": 0,
      "expect_withdrawn": 3,
      "expect_program_plan_id": "pro",
      "expect_program_daily_limit": null,
      "expect_program_daily_used": 1,
      "expect_transitions_count": 5
    },
    {
      "op": "settlement.vault_reconciliation.export.verify",
      "export_ref": "export_pro_1",
      "expect_verify_ok": true,
      "expect_verify_public_ok": true
    },

    {
      "op": "partner_program.clear",
      "partner_id": "swapgraph",
      "reset_usage": false
    },
    {
      "op": "settlement.vault_reconciliation.export",
      "proposal_ref": "p3",
      "actor_ref": "partner",
      "auth": { "scopes": ["settlement:read"] },
      "query": {
        "include_transitions": true,
        "now_iso": "2026-02-19T03:43:50Z",
        "exported_at_iso": "2026-02-19T03:43:50Z"
      },
      "expect_ok": false,
      "expect_error_code": "FORBIDDEN",
      "expect_reason_code": "partner_program_missing"
    }
  ]
}
